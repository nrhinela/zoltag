<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoCat System Administration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: #f5f5f5;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #f8f9fa;
            color: #333;
        }

        .tab.active {
            background: white;
            color: #007bff;
            border-color: #007bff;
            position: relative;
            bottom: -2px;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group.checkbox label {
            margin-bottom: 0;
        }

        .form-group.checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-cog"></i> PhotoCat System Administration</h1>
                    <p>Tenant configuration and system management</p>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="window.location.href='/'">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Tenant List View -->
        <div id="tenant-list-view">
        <h2 style="margin-bottom: 20px;">Tenant Management</h2>
        <div id="tenants-error" class="error" style="display: none;"></div>
        <div id="tenants-success" class="success" style="display: none;"></div>
        <div style="margin-bottom: 20px;">
            <button id="show-new-tenant-btn" class="btn btn-primary" onclick="showNewTenantForm()">+ New Tenant</button>
            <form id="new-tenant-form" onsubmit="createNewTenant(event)" style="display:none; margin-top: 15px; gap: 10px; align-items: flex-end;">
                <input type="text" id="new-tenant-id" required pattern="[a-z0-9\-]+" placeholder="ID" maxlength="32" autocomplete="off" style="width: 120px; display: inline-block; margin-right: 10px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" title="Lowercase letters, numbers, and hyphens only">
                <input type="text" id="new-tenant-name" required placeholder="Display Name" style="width: 260px; display: inline-block; margin-right: 10px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <button type="submit" class="btn btn-success" style="padding: 6px 18px; margin-right: 6px;">Create</button>
                <button type="button" class="btn btn-secondary" onclick="hideNewTenantForm()">Cancel</button>
            </form>
            <div style="font-size: 12px; color: #666; margin-top: 4px;" id="new-tenant-hint">Tenant ID: lowercase, numbers, hyphens only</div>
        </div>
        <!-- Existing Tenants -->
        <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">Existing Tenants</h3>
            <table id="tenants-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Storage</th>
                        <th>Dropbox</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Tenant Editor View -->
    <div id="tenant-editor-view" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <button class="btn btn-secondary" onclick="closeTenantEditor()">
                    ‚Üê Back to Tenants
                </button>
            </div>
            <div>
                <h2 style="display: inline-block; margin: 0;">Editing: <span id="current-tenant-name"></span></h2>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="tenant-settings">Settings</div>
            <div class="tab" data-tab="tenant-dropbox">Dropbox Setup</div>
        </div>

        <!-- Settings Tab -->
        <div id="tenant-settings" class="tab-content active">
            <div id="settings-error" class="error" style="display: none;"></div>
            <div id="settings-success" class="success" style="display: none;"></div>

            <!-- System Settings (Read-Only) -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">System Settings (Read-Only)</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Environment</div>
                        <div style="font-size: 16px; font-weight: 600; font-family: monospace; color: #333;" id="system-environment">-</div>
                    </div>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">GCP Project</div>
                        <div style="font-size: 14px; font-weight: 500; font-family: monospace; color: #333;" id="system-project">-</div>
                    </div>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Region</div>
                        <div style="font-size: 14px; font-weight: 500; font-family: monospace; color: #333;" id="system-region">-</div>
                    </div>
                    <div style="padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Default Storage Bucket</div>
                        <div style="font-size: 13px; font-weight: 500; font-family: monospace; color: #333;" id="system-storage-bucket">-</div>
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3>Tenant Details</h3>
                <form id="tenant-settings-form" onsubmit="saveTenantSettings(event)">
                    <input type="hidden" id="settings-tenant-id">
                    <div class="form-group">
                        <label>Tenant ID *</label>
                        <input type="text" id="settings-id" required disabled>
                        <small style="color: #666;">Cannot be changed after creation</small>
                    </div>
                    <div class="form-group">
                        <label>Display Name *</label>
                        <input type="text" id="settings-name" required>
                    </div>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="settings-active">
                        <label for="settings-active">Active</label>
                    </div>

                    <h3 style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">Storage Configuration</h3>
                    <div style="background: #e7f3ff; border-left: 4px solid #0066cc; padding: 12px; margin-bottom: 20px; border-radius: 4px;">
                        <p style="margin: 0; color: #333; font-size: 14px;"><strong>Storage Bucket Convention:</strong></p>
                        <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #666; font-size: 13px;">
                            <li><strong>Shared bucket (default):</strong> <code id="shared-bucket-name">{project}-{ENV}-shared</code></li>
                            <li><strong>Tenant-specific:</strong> <code id="dedicated-bucket-name">{project}-{ENV}-{tenant_id}</code></li>
                            <li>Paths always include tenant ID: <code>{tenant_id}/thumbnails/image.jpg</code></li>
                        </ul>
                        <p style="margin: 8px 0 0 0; color: #666; font-size: 13px;">To set up a dedicated bucket, check the box below and run:</p>
                        <code style="display: block; margin-top: 8px; padding: 8px; background: white; border-radius: 4px; font-family: monospace; font-size: 12px;">python scripts/setup_tenant_buckets.py --tenant-id <span id="bucket-setup-tenant-id">TENANT_ID</span></code>
                    </div>
                    <div class="form-group checkbox">
                        <input type="checkbox" id="settings-dedicated-bucket" onchange="updateBucketDisplay()">
                        <label for="settings-dedicated-bucket">Use dedicated bucket for this tenant</label>
                    </div>
                    <div id="bucket-display" style="padding: 12px; background: #f8f9fa; border-radius: 6px; margin-top: 10px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Active bucket:</div>
                        <div style="font-size: 14px; font-weight: 500; font-family: monospace; color: #333;" id="computed-bucket-name">-</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;" id="bucket-type-label">Shared bucket (default)</div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
                
                <!-- Danger Zone -->
                <div style="margin-top: 40px; padding: 20px; background: #fff5f5; border: 2px solid #fc8181; border-radius: 8px;">
                    <h4 style="color: #c53030; margin-top: 0;">‚ö†Ô∏è Danger Zone</h4>
                    <p style="color: #666; margin-bottom: 15px;">Deleting a tenant is permanent and will remove all associated data including keywords, people, and image metadata.</p>
                    <div class="form-group">
                        <label>Type <strong>I really mean it</strong> to confirm deletion:</label>
                        <input type="text" id="delete-confirmation" placeholder="Type exactly: I really mean it" style="font-family: monospace;">
                    </div>
                    <button type="button" class="btn btn-danger" onclick="deleteCurrentTenant()" style="background: #c53030;">
                        <i class="fas fa-trash mr-2"></i>Delete Tenant
                    </button>
                </div>
            </div>
        </div>

        <!-- Dropbox Setup Tab -->
        <div id="tenant-dropbox" class="tab-content">
            <div id="dropbox-error" class="error" style="display: none;"></div>
            <div id="dropbox-success" class="success" style="display: none;"></div>
            <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3>Dropbox Integration</h3>
                <p style="color: #666; margin-bottom: 20px;">Connect this tenant to Dropbox for automatic file synchronization</p>
                
                <!-- App Key Configuration -->
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
                    <h4 style="margin-top: 0; color: #007bff;">1. Configure App Key</h4>
                <form id="dropbox-settings-form" onsubmit="saveDropboxSettings(event)">
                    <input type="hidden" id="dropbox-tenant-id">
                    <div class="form-group">
                        <label>Dropbox App Key *</label>
                        <input type="text" id="dropbox-app-key" placeholder="abc123xyz456" required>
                        <small style="color: #666;">Public identifier from your Dropbox App Console</small>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="submit" class="btn btn-primary">Save App Key</button>
                    </div>
                </form>
                </div>
                
                <!-- OAuth Connection Section -->
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745;">
                    <h4 style="margin-top: 0; color: #28a745;">2. Connect to Dropbox</h4>
                    <p style="color: #666; margin-bottom: 15px;">Authorize PhotoCat to access this tenant's Dropbox account. This will automatically create and store the refresh token in Secret Manager.</p>
                    <button type="button" class="btn btn-primary" onclick="connectTenantDropbox()">
                        <i class="fab fa-dropbox" style="margin-right: 8px;"></i>Connect Dropbox Account
                    </button>
                    <div id="dropbox-connection-status" style="margin-top: 10px; font-size: 14px;"></div>
                </div>
                
                <!-- Current Configuration Display -->
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #6c757d;">
                    <h4 style="margin-top: 0; color: #6c757d;">3. Current Configuration</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #495057;">App Secret Reference</label>
                        <code id="dropbox-app-secret" style="display: block; padding: 10px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; color: #212529; font-size: 13px;">Not configured</code>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #495057;">Refresh Token Reference</label>
                        <code id="dropbox-access-token" style="display: block; padding: 10px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; color: #212529; font-size: 13px;">Not configured</code>
                        <small style="color: #666; display: block; margin-top: 5px;">Automatically populated by OAuth flow</small>
                    </div>
                </div>

                <!-- Sync Folders Configuration -->
                <div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin-top: 0; color: #17a2b8;">4. Sync Folders (Optional)</h4>
                    <p style="color: #666; margin-bottom: 15px;">Specify which Dropbox folders to sync. Leave empty to sync all folders in your Dropbox.</p>

                    <div id="sync-folders-list" style="margin-bottom: 15px;">
                        <!-- Folder paths will be added here -->
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="new-sync-folder" placeholder="/Archive - Photo/Events/2025 Events" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-primary" onclick="addSyncFolder()">Add Folder</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-primary" onclick="saveSyncFolders()">Save Sync Folders</button>
                    </div>

                    <small style="color: #666; display: block; margin-top: 10px;">
                        Examples: /Archive - Photo/Events/2025 Events, /Camera Uploads, /Photos<br>
                        Leave list empty to sync entire Dropbox without folder restrictions.
                    </small>
                </div>

                <!-- Setup Instructions -->
                <div style="padding: 20px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #0066cc;">
                    <h4 style="margin-top: 0; color: #0066cc;">üìã Initial Setup Instructions</h4>
                    <p style="color: #333; margin-bottom: 10px;"><strong>Before connecting, create required secrets in Google Cloud Secret Manager:</strong></p>
                    <ol style="color: #666; line-height: 1.8; margin: 10px 0;">
                        <li>Create Dropbox app at <a href="https://www.dropbox.com/developers/apps" target="_blank">Dropbox App Console</a></li>
                        <li>Copy your App Key from the Dropbox console</li>
                        <li>Copy your App Secret from the Dropbox console</li>
                        <li>Create App Secret in Secret Manager (replace YOUR_APP_SECRET with actual value):
                            <pre style="background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; margin: 8px 0; overflow-x: auto; font-size: 12px; line-height: 1.6;">echo -n "YOUR_APP_SECRET" | \
  gcloud secrets create dropbox-app-secret-<span id="secret-tenant-id">TENANT_ID</span> \
  --data-file=- \
  --project=photocat-483622</pre>
                        </li>
                        <li>Enter your App Key in the form above and click "Save App Key"</li>
                        <li>Click "Connect Dropbox Account" - this will automatically create the refresh token secret</li>
                    </ol>
                </div>
            </div>
        </div>

    </div>

    <!-- Old tab structure (hidden) -->
    <div style="display: none;">
    <div class="tabs">
        <div class="tab active" data-tab="tenants">Tenants</div>
        <div class="tab" data-tab="keywords">Keywords</div>
        <div class="tab" data-tab="people">People</div>
        <div class="tab" data-tab="settings">Settings</div>
    </div>

    <!-- Tenants Tab -->
    <div id="tenants" class="tab-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Tenant Management</h2>
            <button class="btn btn-primary" onclick="showTenantModal()">+ New Tenant</button>
        </div>
        <div id="tenants-error" class="error" style="display: none;"></div>
        <div id="tenants-success" class="success" style="display: none;"></div>
        <table id="tenants-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Dropbox</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    </div>

    <!-- Keywords Tab (old) -->
    <div id="keywords" class="tab-content" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2>Keywords Configuration</h2>
                <p style="color: #666; margin-top: 5px;">Edit keywords for tenant: <select id="keywords-tenant-selector" onchange="loadKeywords()" style="width: auto; display: inline-block; margin-left: 10px;"></select></p>
            </div>
        </div>
        <div id="keywords-error" class="error" style="display: none;"></div>
        <div id="keywords-success" class="success" style="display: none;"></div>
        <textarea id="keywords-editor" style="width: 100%; min-height: 500px; font-family: 'Monaco', 'Consolas', monospace; font-size: 13px; padding: 15px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Loading..."></textarea>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" onclick="saveKeywords()">Save Keywords</button>
            <button class="btn btn-secondary" onclick="loadKeywords()">Reload</button>
            <button class="btn btn-secondary" onclick="formatKeywords()">Format JSON</button>
        </div>
    </div>

    <!-- People Tab -->
    <div id="people" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2>People Management</h2>
                <p style="color: #666; margin-top: 5px;">Filter by tenant: <select id="people-tenant-filter" style="width: auto; display: inline-block; margin-left: 10px;" onchange="loadPeople()">
                    <option value="">All Tenants</option>
                </select></p>
            </div>
            <button class="btn btn-primary" onclick="showPersonModal()">+ New Person</button>
        </div>
        <div id="people-error" class="error" style="display: none;"></div>
        <div id="people-success" class="success" style="display: none;"></div>
        <table id="people-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tenant</th>
                    <th>Name</th>
                    <th>Aliases</th>
                    <th>Face Data</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    </div>
    <!-- End old hidden tab structure -->

    <!-- Person Modal -->
    <div id="person-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="person-modal-title">New Person</h2>
                <span class="close" onclick="closePersonModal()">&times;</span>
            </div>
            <form id="person-form" onsubmit="savePerson(event)">
                <input type="hidden" id="person-edit-id">
                <div class="form-group">
                    <label>Tenant *</label>
                    <select id="person-tenant-id" required></select>
                </div>
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="person-name" required>
                </div>
                <div class="form-group">
                    <label>Aliases (comma-separated)</label>
                    <input type="text" id="person-aliases" placeholder="e.g., Johnny, John Jr">
                </div>
                <div class="form-group">
                    <label>Face Embedding Reference</label>
                    <input type="text" id="person-embedding">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePersonModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/api/tenant_photo_count.js"></script>
    <script>
        // Global state
        let currentTenantId = null;
        let systemSettings = null;

        // Tab switching for tenant editor
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName).classList.add('active');

                // Load data for active tab in tenant editor
                if (tabName === 'tenant-people') loadPeopleForTenant();
            });
        });

        // Load system settings
        async function loadSystemSettings() {
            try {
                const response = await fetch('/api/v1/config/system');
                systemSettings = await response.json();

                // Update UI
                document.getElementById('system-environment').textContent = systemSettings.environment.toUpperCase();
                document.getElementById('system-project').textContent = systemSettings.gcp_project_id;
                document.getElementById('system-region').textContent = systemSettings.gcp_region;
                document.getElementById('system-storage-bucket').textContent = systemSettings.storage_bucket_name;

                // Update bucket convention display
                document.getElementById('shared-bucket-name').textContent = systemSettings.storage_bucket_name;

                // Color-code environment
                const envEl = document.getElementById('system-environment');
                if (systemSettings.environment.toLowerCase() === 'prod') {
                    envEl.style.color = '#c53030';
                } else {
                    envEl.style.color = '#38a169';
                }
            } catch (error) {
                console.error('Failed to load system settings:', error);
            }
        }

        // Tenant Editor Functions
        async function openTenantEditor(tenantId) {
            currentTenantId = tenantId;

            // Load system settings
            await loadSystemSettings();

            // Fetch tenant details
            const response = await fetch('/api/v1/admin/tenants');
            const tenants = await response.json();
            const tenant = tenants.find(t => t.id === tenantId);

            if (!tenant) {
                alert('Tenant not found');
                return;
            }

            // Update UI
            document.getElementById('current-tenant-name').textContent = tenant.name;
            document.getElementById('tenant-list-view').style.display = 'none';
            document.getElementById('tenant-editor-view').style.display = 'block';

            // Populate settings form
            document.getElementById('settings-tenant-id').value = tenant.id;
            document.getElementById('settings-id').value = tenant.id;
            document.getElementById('settings-name').value = tenant.name;
            document.getElementById('settings-active').checked = tenant.active;

            // Check if tenant has dedicated bucket
            const hasDedicatedBucket = tenant.thumbnail_bucket && tenant.thumbnail_bucket !== '';
            document.getElementById('settings-dedicated-bucket').checked = hasDedicatedBucket;

            // Update bucket setup command with actual tenant ID
            document.getElementById('bucket-setup-tenant-id').textContent = tenant.id;

            // Update bucket display
            updateBucketDisplay();

            // Populate Dropbox form
            document.getElementById('dropbox-tenant-id').value = tenant.id;
            document.getElementById('dropbox-app-key').value = tenant.dropbox_app_key || '';
            
            // Construct Secret Manager paths from tenant ID
            const projectId = 'photocat-483622';
            const appSecretPath = `projects/${projectId}/secrets/dropbox-app-secret-${tenant.id}/versions/latest`;
            const tokenPath = `projects/${projectId}/secrets/dropbox-token-${tenant.id}/versions/latest`;
            
            // Check if secrets exist by trying to display them
            checkSecretExists(appSecretPath, 'dropbox-app-secret');
            checkSecretExists(tokenPath, 'dropbox-access-token');
            
            // Update tenant ID placeholders in instructions
            document.getElementById('secret-tenant-id').textContent = tenant.id;
            document.querySelectorAll('.tenant-id-display').forEach(el => el.textContent = tenant.id);

            // Load sync folders
            loadSyncFolders(tenant);

            // Load initial data
            loadKeywords();
        }
        
        async function checkSecretExists(secretPath, elementId) {
            // For now, just display the path
            // In production, you could call an API endpoint to verify
            document.getElementById(elementId).textContent = secretPath;
        }

        // Sync folders management
        let syncFolders = [];

        function loadSyncFolders(tenant) {
            // Load sync folders from tenant settings
            syncFolders = (tenant.settings && tenant.settings.dropbox_sync_folders) || [];
            renderSyncFolders();
        }

        function renderSyncFolders() {
            const container = document.getElementById('sync-folders-list');
            if (syncFolders.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">No folders configured - will sync entire Dropbox</p>';
            } else {
                container.innerHTML = syncFolders.map((folder, index) => `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; background: white; border: 1px solid #dee2e6; border-radius: 4px;">
                        <code style="flex: 1; color: #212529; font-size: 13px;">${folder}</code>
                        <button type="button" class="btn" onclick="removeSyncFolder(${index})" style="padding: 4px 12px; font-size: 12px; background: #dc3545; color: white;">Remove</button>
                    </div>
                `).join('');
            }
        }

        function addSyncFolder() {
            const input = document.getElementById('new-sync-folder');
            if (!input) {
                console.error('Input element not found');
                return;
            }

            const folder = input.value.trim();

            if (!folder) {
                alert('Please enter a folder path');
                return;
            }

            if (!folder.startsWith('/')) {
                alert('Folder path must start with /');
                return;
            }

            if (syncFolders.includes(folder)) {
                alert('This folder is already in the list');
                return;
            }

            syncFolders.push(folder);
            renderSyncFolders();
            input.value = '';
            input.focus();
        }

        function removeSyncFolder(index) {
            syncFolders.splice(index, 1);
            renderSyncFolders();
        }

        async function saveSyncFolders() {
            if (!currentTenantId) {
                alert('No tenant selected');
                return;
            }

            try {
                const response = await fetch(`/api/v1/admin/tenants/${currentTenantId}/settings`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dropbox_sync_folders: syncFolders
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save sync folders');
                }

                alert('Sync folders saved successfully!');
            } catch (error) {
                console.error('Error saving sync folders:', error);
                alert('Failed to save sync folders: ' + error.message);
            }
        }

        function closeTenantEditor() {
            document.getElementById('tenant-editor-view').style.display = 'none';
            document.getElementById('tenant-list-view').style.display = 'block';
            currentTenantId = null;
            loadTenants();
        }

        // Load initial data
        loadTenants();

        // Tenant functions
        async function loadTenants() {
            try {
                const response = await fetch('/api/v1/admin/tenants');
                const tenants = await response.json();
                
                const tbody = document.querySelector('#tenants-table tbody');
                tbody.innerHTML = tenants.map(t => {
                    const hasStorage = t.thumbnail_bucket;
                    return `
                    <tr>
                        <td>${t.id}</td>
                        <td>${t.name}</td>
                        <td>
                            <span class="badge ${t.active ? 'badge-success' : 'badge-danger'}">
                                ${t.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${hasStorage ? 'badge-success' : 'badge-danger'}" title="${hasStorage ? 'Dedicated buckets configured' : 'Using shared buckets'}">
                                ${hasStorage ? 'Dedicated' : 'Shared'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${t.dropbox_configured ? 'badge-success' : 'badge-danger'}">
                                ${t.dropbox_configured ? 'Configured' : 'Not configured'}
                            </span>
                        </td>
                        <td>${new Date(t.created_at).toLocaleDateString()}</td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="openTenantEditor('${t.id}')">Edit</button>
                        </td>
                    </tr>
                `;
                }).join('');

                // Update people tenant filter
                const select = document.getElementById('people-tenant-filter');
                select.innerHTML = '<option value="">All Tenants</option>' + 
                    tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

                // Update person modal tenant selector
                const personTenantSelect = document.getElementById('person-tenant-id');
                personTenantSelect.innerHTML = tenants.map(t => 
                    `<option value="${t.id}">${t.name}</option>`
                ).join('');

                // Update keywords tenant selector
                const keywordsTenantSelect = document.getElementById('keywords-tenant-selector');
                keywordsTenantSelect.innerHTML = '<option value="">Select Tenant</option>' +
                    tenants.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                // Auto-select first tenant if available
                if (tenants.length > 0) {
                    keywordsTenantSelect.value = tenants[0].id;
                }
            } catch (error) {
                showError('tenants', 'Failed to load tenants: ' + error.message);
            }
        }


        function showNewTenantForm() {
            document.getElementById('show-new-tenant-btn').style.display = 'none';
            document.getElementById('new-tenant-form').style.display = 'inline-block';
            document.getElementById('new-tenant-id').focus();
        }

        function hideNewTenantForm() {
            document.getElementById('show-new-tenant-btn').style.display = '';
            document.getElementById('new-tenant-form').style.display = 'none';
            document.getElementById('new-tenant-form').reset();
        }

        async function createNewTenant(event) {
            event.preventDefault();
            const tenantId = document.getElementById('new-tenant-id').value.trim().toLowerCase();
            const tenantName = document.getElementById('new-tenant-name').value.trim();
            if (!/^[a-z0-9-]+$/.test(tenantId)) {
                showError('tenants', 'Tenant ID must contain only lowercase letters, numbers, and hyphens');
                document.getElementById('new-tenant-id').focus();
                return;
            }
            const data = {
                id: tenantId,
                name: tenantName,
                active: true
            };
            try {
                const response = await fetch('/api/v1/admin/tenants', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create tenant');
                }
                document.getElementById('new-tenant-form').reset();
                hideNewTenantForm();
                showSuccess('tenants', `Tenant "${tenantName}" created successfully`);
                loadTenants();
            } catch (error) {
                showError('tenants', error.message);
            }
        }

        function updateBucketDisplay() {
            const tenantId = document.getElementById('settings-id').value;
            const useDedicated = document.getElementById('settings-dedicated-bucket').checked;
            const computedBucketName = document.getElementById('computed-bucket-name');
            const bucketTypeLabel = document.getElementById('bucket-type-label');

            if (!systemSettings) return;

            // Use lowercase for GCS bucket name compatibility
            const env = systemSettings.environment.toLowerCase();
            const projectId = systemSettings.gcp_project_id;

            if (useDedicated && tenantId) {
                // Dedicated bucket
                const bucketName = `${projectId}-${env}-${tenantId}`;
                computedBucketName.textContent = bucketName;
                bucketTypeLabel.textContent = 'Dedicated tenant bucket';
                bucketTypeLabel.style.color = '#0066cc';

                // Update the dedicated bucket example in the convention display
                document.getElementById('dedicated-bucket-name').textContent = bucketName;
            } else {
                // Shared bucket
                const sharedBucket = `${projectId}-${env}-shared`;
                computedBucketName.textContent = sharedBucket;
                bucketTypeLabel.textContent = 'Shared bucket (default)';
                bucketTypeLabel.style.color = '#999';
            }
        }

        async function saveTenantSettings(event) {
            event.preventDefault();

            const tenantId = document.getElementById('settings-tenant-id').value;
            const useDedicatedBucket = document.getElementById('settings-dedicated-bucket').checked;

            // Compute bucket name if dedicated bucket is checked
            let thumbnailBucket = null;
            if (useDedicatedBucket && systemSettings) {
                const env = systemSettings.environment.toUpperCase();
                const projectId = systemSettings.gcp_project_id;
                thumbnailBucket = `${projectId}-${env}-${tenantId}`;
            }

            const data = {
                id: tenantId,
                name: document.getElementById('settings-name').value,
                active: document.getElementById('settings-active').checked,
                thumbnail_bucket: thumbnailBucket
            };

            try {
                const response = await fetch(`/api/v1/admin/tenants/${tenantId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save tenant settings');
                }

                // Update tenant name in header
                document.getElementById('current-tenant-name').textContent = data.name;
                showSuccess('settings', 'Settings saved successfully');
            } catch (error) {
                showError('settings', error.message);
            }
        }

        function connectTenantDropbox() {
            if (!currentTenantId) {
                showError('dropbox', 'No tenant selected');
                return;
            }
            
            // Open OAuth flow in new window
            const statusDiv = document.getElementById('dropbox-connection-status');
            statusDiv.innerHTML = '<span style="color: #666;">Opening authentication window...</span>';
            
            const authWindow = window.open(
                `/oauth/dropbox/authorize?tenant=${currentTenantId}`, 
                'dropbox_oauth', 
                'width=800,height=600'
            );
            
            // Check if popup was blocked
            if (!authWindow || authWindow.closed || typeof authWindow.closed == 'undefined') {
                statusDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è Popup blocked. Please allow popups for this site.</span>';
            } else {
                statusDiv.innerHTML = '<span style="color: #28a745;">‚úì Authentication window opened. Complete the authorization in the popup.</span>';
            }
        }

        async function saveDropboxSettings(event) {
            event.preventDefault();
            
            const tenantId = document.getElementById('dropbox-tenant-id').value;
            
            const data = {
                id: tenantId,
                dropbox_app_key: document.getElementById('dropbox-app-key').value
            };

            try {
                const response = await fetch(`/api/v1/admin/tenants/${tenantId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save Dropbox settings');
                }

                showSuccess('dropbox', 'Dropbox settings saved successfully');
            } catch (error) {
                showError('dropbox', error.message);
            }
        }

        async function deleteCurrentTenant() {
            const confirmation = document.getElementById('delete-confirmation').value;
            if (confirmation !== 'I really mean it') {
                showError('settings', 'Please type "I really mean it" exactly to confirm deletion');
                return;
            }
            if (!currentTenantId) {
                showError('settings', 'No tenant selected');
                return;
            }
            // Check photo count before allowing delete
            const photoCount = await window.getTenantPhotoCount(currentTenantId);
            if (photoCount > 0) {
                showError('settings', `Cannot delete tenant: ${photoCount} photo(s) owned. Delete all photos first.`);
                return;
            }
            try {
                const response = await fetch(`/api/v1/admin/tenants/${currentTenantId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete tenant');
                // Close editor and return to list
                closeTenantEditor();
                showSuccess('tenants', 'Tenant deleted successfully');
            } catch (error) {
                showError('settings', error.message);
            }
        }

        async function deleteTenant(tenantId) {
            if (!confirm(`Are you sure you want to delete tenant ${tenantId}? This will delete all associated data.`)) {
                return;
            }
            // Check photo count before allowing delete
            const photoCount = await window.getTenantPhotoCount(tenantId);
            if (photoCount > 0) {
                showError('tenants', `Cannot delete tenant: ${photoCount} photo(s) owned. Delete all photos first.`);
                return;
            }
            try {
                const response = await fetch(`/api/v1/admin/tenants/${tenantId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete tenant');
                showSuccess('tenants', 'Tenant deleted successfully');
                loadTenants();
            } catch (error) {
                showError('tenants', error.message);
            }
        }

        // People functions
        async function loadPeopleForTenant() {
            if (!currentTenantId) {
                showError('people', 'No tenant selected');
                return;
            }

            const url = `/api/v1/admin/people?tenant_id=${currentTenantId}`;

            try {
                const response = await fetch(url);
                const people = await response.json();
                
                const tbody = document.querySelector('#people-table tbody');
                tbody.innerHTML = people.map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${(p.aliases || []).join(', ') || '-'}</td>
                        <td>
                            <span class="badge ${p.face_embedding_ref ? 'badge-success' : 'badge-danger'}">
                                ${p.face_embedding_ref ? 'Yes' : 'No'}
                            </span>
                        </td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary" onclick="editPerson(${p.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deletePerson(${p.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showError('people', 'Failed to load people: ' + error.message);
            }
        }

        // Old loadPeople function for reference (kept for backward compatibility)
        async function loadPeople() {
            const tenantFilter = document.getElementById('people-tenant-filter').value;
            const url = tenantFilter ? `/api/v1/admin/people?tenant_id=${tenantFilter}` : '/api/v1/admin/people';

            try {
                const response = await fetch(url);
                const people = await response.json();
                
                const tbody = document.querySelector('#people-table tbody');
                tbody.innerHTML = people.map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.tenant_id}</td>
                        <td>${p.name}</td>
                        <td>${(p.aliases || []).join(', ') || '-'}</td>
                        <td>
                            <span class="badge ${p.face_embedding_ref ? 'badge-success' : 'badge-danger'}">
                                ${p.face_embedding_ref ? 'Yes' : 'No'}
                            </span>
                        </td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary" onclick="editPerson(${p.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deletePerson(${p.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showError('people', 'Failed to load people: ' + error.message);
            }
        }

        // Add filter listener
        document.getElementById('people-tenant-filter').addEventListener('change', loadPeople);

        function showPersonModal(personId = null) {
            if (personId) {
                document.getElementById('person-modal-title').textContent = 'Edit Person';
            } else {
                document.getElementById('person-modal-title').textContent = 'New Person';
                document.getElementById('person-form').reset();
                // Auto-set tenant if in tenant editor
                if (currentTenantId) {
                    document.getElementById('person-tenant-id').value = currentTenantId;
                    document.getElementById('person-tenant-id').disabled = true;
                } else {
                    document.getElementById('person-tenant-id').disabled = false;
                }
            }
            document.getElementById('person-modal').classList.add('active');
        }

        function closePersonModal() {
            document.getElementById('person-modal').classList.remove('active');
            document.getElementById('person-edit-id').value = '';
            document.getElementById('person-tenant-id').disabled = false;
        }

        async function savePerson(event) {
            event.preventDefault();
            
            const editId = document.getElementById('person-edit-id').value;
            const aliases = document.getElementById('person-aliases').value
                .split(',')
                .map(a => a.trim())
                .filter(a => a);
            
            const data = {
                tenant_id: document.getElementById('person-tenant-id').value,
                name: document.getElementById('person-name').value,
                aliases: aliases,
                face_embedding_ref: document.getElementById('person-embedding').value
            };

            try {
                const url = editId ? `/api/v1/admin/people/${editId}` : '/api/v1/admin/people';
                const method = editId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save person');
                }

                closePersonModal();
                showSuccess('people', 'Person saved successfully');
                if (currentTenantId) {
                    loadPeopleForTenant();
                } else {
                    loadPeople();
                }
            } catch (error) {
                showError('people', error.message);
            }
        }

        async function editPerson(personId) {
            try {
                const response = await fetch(`/api/v1/admin/people`);
                const people = await response.json();
                const person = people.find(p => p.id === personId);
                
                if (!person) {
                    showError('people', 'Person not found');
                    return;
                }
                
                // Populate form
                document.getElementById('person-edit-id').value = person.id;
                document.getElementById('person-tenant-id').value = person.tenant_id;
                document.getElementById('person-name').value = person.name;
                document.getElementById('person-aliases').value = (person.aliases || []).join(', ');
                document.getElementById('person-embedding').value = person.face_embedding_ref || '';
                
                showPersonModal(personId);
            } catch (error) {
                showError('people', 'Failed to load person: ' + error.message);
            }
        }

        async function deletePerson(personId) {
            if (!confirm('Are you sure you want to delete this person?')) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/admin/people/${personId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete person');

                showSuccess('people', 'Person deleted successfully');
                if (currentTenantId) {
                    loadPeopleForTenant();
                } else {
                    loadPeople();
                }
            } catch (error) {
                showError('people', error.message);
            }
        }

        // Keywords functions
        async function loadKeywords() {
            if (!currentTenantId) {
                showError('keywords', 'No tenant selected');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/config/keywords', {
                    headers: { 'X-Tenant-ID': currentTenantId }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const keywords = await response.json();
                const categories = keywordsToCategories(keywords);
                document.getElementById('keywords-editor').value = JSON.stringify(categories, null, 2);
                showSuccess('keywords', 'Keywords loaded');
            } catch (error) {
                showError('keywords', 'Error loading keywords: ' + error.message);
            }
        }

        async function saveKeywords() {
            if (!currentTenantId) {
                showError('keywords', 'No tenant selected');
                return;
            }
            
            try {
                const json = document.getElementById('keywords-editor').value;
                const categories = JSON.parse(json);
                
                const response = await fetch('/api/v1/config/keywords', {
                    method: 'POST',
                    headers: { 
                        'X-Tenant-ID': currentTenantId,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categories)
                });
                
                if (response.ok) {
                    showSuccess('keywords', 'Keywords saved successfully!');
                } else {
                    const error = await response.json();
                    showError('keywords', 'Error saving keywords: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                showError('keywords', 'Error saving keywords: ' + error.message);
            }
        }

        function formatKeywords() {
            try {
                const json = document.getElementById('keywords-editor').value;
                const parsed = JSON.parse(json);
                document.getElementById('keywords-editor').value = JSON.stringify(parsed, null, 2);
                showSuccess('keywords', 'Formatted successfully');
            } catch (error) {
                showError('keywords', 'Invalid JSON: ' + error.message);
            }
        }

        function keywordsToCategories(keywords) {
            const categoryMap = {};
            keywords.forEach(kw => {
                if (!categoryMap[kw.category]) {
                    categoryMap[kw.category] = {
                        name: kw.category,
                        keywords: [],
                        subcategories: []
                    };
                }
                const kwObj = { keyword: kw.keyword };
                if (kw.prompt) kwObj.prompt = kw.prompt;
                categoryMap[kw.category].keywords.push(kwObj);
            });
            return Object.values(categoryMap);
        }

        // Utility functions
        function showError(tab, message) {
            const el = document.getElementById(`${tab}-error`);
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showSuccess(tab, message) {
            const el = document.getElementById(`${tab}-success`);
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

    </script>
    </div>
</body>
</html>
