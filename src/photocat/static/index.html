<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoCat - Image Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .image-card {
            /* ...existing code... */
        }
    </style>
    <script>
    // Add Photo to List handler
    async function addPhotoToList(photoId, event) {
        const btn = event && event.target ? event.target.closest('button') : null;
        if (btn) {
            btn.disabled = true;
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        try {
            const resp = await fetch('/api/v1/lists/add-photo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Tenant-ID': currentTenant
                },
                body: JSON.stringify({ photo_id: photoId })
            });
            if (!resp.ok) throw new Error('Failed to add photo to list');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-check"></i> Added!';
                setTimeout(() => { btn.innerHTML = '<i class="fas fa-list"></i> Add to List'; btn.disabled = false; }, 1200);
            }
        } catch (err) {
            if (btn) {
                btn.innerHTML = '<i class="fas fa-times"></i> Error';
                setTimeout(() => { btn.innerHTML = '<i class="fas fa-list"></i> Add to List'; btn.disabled = false; }, 1500);
            }
            alert('Failed to add photo to list.');
        }
    }
    </script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoCat - Image Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .image-card {
            transition: transform 0.2s;
        }
        .image-card:hover {
            transform: scale(1.02);
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-camera text-blue-600 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-gray-800">PhotoCat</h1>
                    <span id="environment-badge" style="font-size: 12px; padding: 4px 10px; border-radius: 4px; font-weight: 600;">...</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="syncDropbox()" id="syncButton" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">
                        <i class="fas fa-sync mr-2"></i>Sync
                    </button>
                    <button onclick="stopSync()" id="stopButton" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        <i class="fas fa-stop mr-2"></i>Stop
                    </button>
                    <button onclick="retagAllImages()" id="retagButton" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-tags mr-2"></i>Retag All
                    </button>
                    <button onclick="showUploadModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-upload mr-2"></i>Upload
                    </button>
                    <div class="flex items-center space-x-2">
                        <label for="tenantSelect" class="text-gray-700 font-medium">Tenant:</label>
                        <select id="tenantSelect" class="px-4 py-2 border rounded-lg" onchange="switchTenant(this.value)">
                            <option value="">Loading tenants...</option>
                        </select>
                    </div>
                    <button onclick="window.location.href='/tagging-admin'" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700" title="Tagging Settings">
                        <i class="fas fa-tags mr-2"></i>Tagging
                    </button>
                    <button onclick="window.location.href='/admin'" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700" title="System Administration">
                        <i class="fas fa-cog mr-2"></i>Admin
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Tab Bar -->
    <div class="bg-gray-50 border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button id="tab-search" class="text-blue-700 border-b-2 border-blue-600 py-3 px-4 text-sm font-medium focus:outline-none" aria-current="page" onclick="showTab('search')">
                    <i class="fas fa-search mr-1"></i> Search
                </button>
                <button id="tab-lists" class="text-gray-700 border-b-2 border-transparent py-3 px-4 text-sm font-medium focus:outline-none" onclick="showListsScreen()">
                    <i class="fas fa-book mr-1"></i> Lists
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab Content -->
    <div id="tab-search-content" class="max-w-7xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="md:col-span-2">
                    <input
                        id="searchInput"
                        type="text"
                        placeholder="Search tags..."
                        class="w-full px-4 py-2 border rounded-lg"
                        onkeyup="handleSearch()"
                    >
                </div>
                <div>
                    <select id="sortSelect" class="w-full px-4 py-2 border rounded-lg" onchange="loadImages()">
                        <option value="date_desc">Newest First</option>
                        <option value="date_asc">Oldest First</option>
                        <option value="name">By Name</option>
                    </select>
                </div>
                <div>
                    <input
                        type="date"
                        id="dateFilter"
                        class="w-full px-4 py-2 border rounded-lg"
                        onchange="loadImages()"
                    >
                </div>
            </div>

            <!-- Faceted Search -->
            <div class="border-t pt-4">
                <div class="flex items-center gap-4 mb-3">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600 font-semibold">Filter by Keywords:</label>
                        <span id="activeFiltersCount" class="bg-blue-600 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
                    </div>
                    <button onclick="clearFilters()" class="text-sm text-red-600 hover:text-red-700 ml-auto">
                        <i class="fas fa-times mr-1"></i>Clear All
                    </button>
                </div>

                <!-- Tag Input with Autocomplete - One per category -->
                <div id="categoryInputsContainer" class="space-y-3">
                    <!-- Category input fields will be dynamically generated here -->
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">Total Images</div>
                <div id="totalImages" class="text-3xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">With Faces</div>
                <div id="withFaces" class="text-3xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">Tagged</div>
                <div id="tagged" class="text-3xl font-bold text-purple-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">Storage Used</div>
                <div id="storageUsed" class="text-3xl font-bold text-orange-600">0 MB</div>
            </div>
        </div>

        <!-- Display Mode Toggle -->

        <div class="flex justify-end items-center mb-4">
            <div class="flex items-center mr-6">
                <label for="activeListSelect" class="mr-2 text-gray-600 font-medium">Active List:</label>
                <select id="activeListSelect" class="px-3 py-2 border rounded-lg text-gray-700 bg-white" style="min-width: 160px;"></select>
            </div>
            <span class="mr-2 text-gray-600 font-medium">Display:</span>
            <button id="gridModeBtn" onclick="setDisplayMode('grid')" class="px-3 py-2 rounded-l-lg border border-gray-300 bg-white text-gray-700 hover:bg-blue-50 focus:outline-none">
                <i class="fas fa-th-large"></i>
            </button>
            <button id="listModeBtn" onclick="setDisplayMode('list')" class="px-3 py-2 border-t border-b border-gray-300 bg-white text-gray-700 hover:bg-blue-50 focus:outline-none">
                <i class="fas fa-list"></i>
            </button>
        </div>
            <script>
            // --- Active List Dropdown Logic ---
            async function loadActiveListDropdown() {
                const select = document.getElementById('activeListSelect');
                if (!select) return;
                select.innerHTML = '<option>Loading...</option>';
                try {
                    const resp = await fetch('/api/v1/lists', { headers: { 'X-Tenant-ID': currentTenant } });
                    const lists = await resp.json();
                    if (!lists.length) {
                        select.innerHTML = '<option value="">No lists</option>';
                        select.disabled = true;
                        return;
                    }
                    select.disabled = false;
                    // Find active list
                    let activeId = null;
                    for (const l of lists) { if (l.is_active) { activeId = l.id; break; } }
                    select.innerHTML = lists.map(l => `<option value="${l.id}" ${l.is_active ? 'selected' : ''}>${l.title || '(Untitled)'}</option>`).join('');
                    select.value = activeId || lists[0].id;
                } catch (e) {
                    select.innerHTML = '<option>Error loading lists</option>';
                    select.disabled = true;
                }
            }

            document.addEventListener('DOMContentLoaded', loadActiveListDropdown);

            // Also reload dropdown when switching tenants or after list changes
            window.loadActiveListDropdown = loadActiveListDropdown;

            // Set active list when user changes dropdown
            document.addEventListener('change', async function(e) {
                if (e.target && e.target.id === 'activeListSelect') {
                    const listId = e.target.value;
                    if (!listId) return;
                    // Patch the list to set is_active=true
                    try {
                        await fetch(`/api/v1/lists/${listId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Tenant-ID': currentTenant
                            },
                            body: JSON.stringify({ is_active: true })
                        });
                        // Reload dropdown and refresh UI as needed
                        await loadActiveListDropdown();
                        // Optionally, reload images or lists if needed
                    } catch (err) {
                        alert('Failed to set active list.');
                    }
                }
            });
            </script>
    <!-- Lists Tab Content -->
    </div> <!-- close tab-search-content -->
    <div id="tab-lists-content" class="max-w-7xl mx-auto px-4 py-6">
        <div id="listsMainArea"></div>
    </div>

        <!-- Lists Screen (renders in imageGrid) -->
        <script>
        window.showListsScreen = async function showListsScreen() {
            // Switch to Lists tab and load content
            showTab('lists');
            // Fetch lists
            const resp = await fetch('/api/v1/lists', { headers: { 'X-Tenant-ID': currentTenant } });
            const lists = await resp.json();
            let html = `<div class='bg-white rounded-lg shadow p-6 mb-6'>`;
            html += `<div class='flex justify-between items-center mb-4'>`;
            html += `<h2 class='text-2xl font-bold flex items-center'><i class='fas fa-book mr-2'></i> Lists</h2>`;
            html += `<button onclick='showListEditorModal()' class='bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded'><i class="fas fa-plus mr-1"></i> New List</button>`;
            html += `</div>`;
            if (!lists.length) {
                html += `<div class='text-gray-500'>No lists found. Click "New List" to create one.</div>`;
            } else {
                html += `<table class='min-w-full divide-y divide-gray-200 mb-4'><thead><tr><th class='px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase'>Title</th><th class='px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase'>Notes</th><th class='px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase'>Items</th><th class='px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase'>Active</th><th class='px-4 py-2'></th></tr></thead><tbody>`;
                // Fetch item counts for all lists in parallel
                const itemCounts = {};
                await Promise.all(lists.map(async (list) => {
                    try {
                        const resp = await fetch(`/api/v1/lists/${list.id}/items`, { headers: { 'X-Tenant-ID': currentTenant } });
                        const items = await resp.json();
                        itemCounts[list.id] = Array.isArray(items) ? items.length : 0;
                    } catch { itemCounts[list.id] = 0; }
                }));
                for (const list of lists) {
                    html += `<tr class='hover:bg-gray-50'>`;
                    html += `<td class='px-4 py-2 font-semibold'>${list.title || '(Untitled)'}</td>`;
                    html += `<td class='px-4 py-2 text-gray-600'>${list.notebox ? list.notebox.substring(0, 60) : ''}</td>`;
                    html += `<td class='px-4 py-2 text-center'>${itemCounts[list.id] ?? ''}</td>`;
                    html += `<td class='px-4 py-2'>${list.is_active ? `<span class='inline-block px-2 py-1 text-xs rounded bg-green-100 text-green-800'>Active</span>` : `<span class='inline-block px-2 py-1 text-xs rounded bg-gray-200 text-gray-600'>Inactive</span>`}</td>`;
                    html += `<td class='px-4 py-2 text-right'>`;
                    html += `<button onclick='viewList(${list.id})' class='bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2'><i class=\"fas fa-eye mr-1\"></i>View</button>`;
                    html += `<button onclick='editList(${list.id})' class='bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded mr-2'><i class=\"fas fa-edit mr-1\"></i>Edit</button>`;
                    html += `<button onclick='deleteList(${list.id})' class='bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded'><i class=\"fas fa-trash mr-1\"></i>Delete</button>`;
                    html += `</td></tr>`;
                }
                html += `</tbody></table>`;
            }
            html += `</div>`;
            document.getElementById('listsMainArea').innerHTML = html;
        }

                // View list handler (classic view in main area)
                async function viewList(listId) {
                    // Fetch list details
                    window.currentListViewId = listId;

                    const resp = await fetch(`/api/v1/lists/${listId}`, { headers: { 'X-Tenant-ID': currentTenant } });
                    if (!resp.ok) {
                        alert('Failed to load list.');
                        return;
                    }
                    const list = await resp.json();
                    let html = `<div class='bg-white rounded-lg shadow-lg p-6 w-full max-w-5xl mx-auto'>`;
                    html += `<button class='mb-4 text-blue-600 hover:underline' onclick='showListsScreen()'><i class="fas fa-arrow-left mr-1"></i>Back to Lists</button>`;
                    html += `<h3 class='text-2xl font-bold mb-2 flex items-center'><i class="fas fa-book mr-2"></i> ${list.title || '(Untitled)'}</h3>`;
                    html += `<div class='mb-2 text-gray-600'>${list.notebox ? list.notebox : ''}</div>`;
                    html += `<div class='mb-4 flex justify-between items-center'>`;
                    html += `<span class='font-semibold'>Photos in List:</span>`;
                    html += `<span class='flex items-center gap-2'>`;
                    html += `<span class="mr-2 text-gray-600 font-medium">Display:</span>`;
                    html += `<button id="listGridModeBtn" class="px-3 py-2 rounded-l-lg border border-gray-300 bg-white text-gray-700 hover:bg-blue-50 focus:outline-none"><i class="fas fa-th-large"></i></button>`;
                    html += `<button id="listListModeBtn" class="px-3 py-2 border-t border-b border-gray-300 bg-white text-gray-700 hover:bg-blue-50 focus:outline-none"><i class="fas fa-list"></i></button>`;
                    html += `</span></div>`;
                    html += `<div id='listItemsContainer'></div>`;
                    html += `</div>`;
                    document.getElementById('listsMainArea').innerHTML = html;
                    // Default to grid mode
                    window.listDisplayMode = 'grid';
                    document.getElementById('listGridModeBtn').onclick = function() {
                        window.listDisplayMode = 'grid';
                        renderListItems();
                    };
                    document.getElementById('listListModeBtn').onclick = function() {
                        window.listDisplayMode = 'list';
                        renderListItems();
                    };
                    // Load and render items
                    async function renderListItems() {
                        const container = document.getElementById('listItemsContainer');
                        container.innerHTML = '<div class="col-span-full text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i> Loading...</div>';
                        const resp = await fetch(`/api/v1/lists/${listId}/items`, { headers: { 'X-Tenant-ID': currentTenant } });
                        const items = await resp.json();
                        if (!items.length) {
                            container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No photos in this list.</div>';
                            return;
                        }
                        const images = await Promise.all(items.map(async item => {
                            const resp = await fetch(`/api/v1/images/${item.photo_id}`, { headers: { 'X-Tenant-ID': currentTenant } });
                            const image = await resp.json();
                            return { image, item };
                        }));
                        if (window.listDisplayMode === 'list') {
                            container.className = '';
                            container.innerHTML = images.map(({image, item}) => renderListImageRow(image, item)).join('');
                        } else {
                            container.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
                            container.innerHTML = images.map(({image, item}) => renderListImageCard(image, item)).join('');
                        }
                    }
                    renderListItems();
            }

        // Show modal for new/edit list
        function showListEditorModal(list) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40';
            modal.innerHTML = `
                <div class='bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative'>
                    <button class='absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl' onclick='this.closest(".fixed").remove()'>&times;</button>
                    <h3 class='text-xl font-bold mb-4'>${list ? 'Edit List' : 'New List'}</h3>
                    <form id='listEditorForm'>
                        <div class='mb-4'>
                            <label class='block text-gray-700 font-semibold mb-1'>Title</label>
                            <input type='text' id='listEditorTitle' class='border px-3 py-2 rounded w-full' value='${list ? list.title : ''}' required>
                        </div>
                        <div class='mb-4'>
                            <label class='block text-gray-700 font-semibold mb-1'>Notes</label>
                            <textarea id='listEditorNotes' class='border px-3 py-2 rounded w-full' rows='3'>${list ? list.notebox || '' : ''}</textarea>
                        </div>
                        <div class='flex justify-end gap-2'>
                            <button type='button' class='bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded' onclick='this.closest(".fixed").remove()'>Cancel</button>
                            <button type='submit' class='bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded'>Save</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('listEditorForm').onsubmit = async function(e) {
                e.preventDefault();
                const title = document.getElementById('listEditorTitle').value;
                const notebox = document.getElementById('listEditorNotes').value;
                if (list) {
                    // Edit existing
                    const resp = await fetch(`/api/v1/lists/${list.id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'X-Tenant-ID': currentTenant },
                        body: JSON.stringify({ title, notebox })
                    });
                    if (resp.ok) {
                        modal.remove();
                        showListsScreen();
                    } else {
                        alert('Failed to update list.');
                    }
                } else {
                    // New list
                    const resp = await fetch('/api/v1/lists', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Tenant-ID': currentTenant },
                        body: JSON.stringify({ title, notebox })
                    });
                    if (resp.ok) {
                        modal.remove();
                        showListsScreen();
                    } else {
                        alert('Failed to create list.');
                    }
                }
            };
        }

        // Edit list handler
        async function editList(listId) {
            const resp = await fetch(`/api/v1/lists/${listId}`, { headers: { 'X-Tenant-ID': currentTenant } });
            if (resp.ok) {
                const list = await resp.json();
                showListEditorModal(list);
            } else {
                alert('Failed to load list.');
            }
        }

        // Delete list handler
        async function deleteList(listId) {
            if (!confirm('Delete this list? This cannot be undone.')) return;
            const resp = await fetch(`/api/v1/lists/${listId}`, { method: 'DELETE', headers: { 'X-Tenant-ID': currentTenant } });
            if (resp.ok) {
                showListsScreen();
            } else {
                alert('Failed to delete list.');
            }
        }
        // Tab switching logic
        function showTab(tab) {
            const imageGridContainer = document.getElementById('imageGrid')?.parentElement;
            // Tab buttons
            const searchBtn = document.getElementById('tab-search');
            const listsBtn = document.getElementById('tab-lists');
            // Tab content
            const searchContent = document.getElementById('tab-search-content');
            const listsContent = document.getElementById('tab-lists-content');

            // Hide all tab contents first
            if (searchContent) searchContent.classList.add('hidden');
            if (listsContent) listsContent.classList.add('hidden');
            // Remove active/selected styles from all tabs
            if (searchBtn) {
                searchBtn.classList.remove('text-blue-700', 'border-blue-600');
                searchBtn.classList.add('text-gray-700', 'border-transparent');
            }
            if (listsBtn) {
                listsBtn.classList.remove('text-blue-700', 'border-blue-600');
                listsBtn.classList.add('text-gray-700', 'border-transparent');
            }

            // Show selected tab content and set active style
            if (tab === 'search') {
                if (searchBtn) {
                    searchBtn.classList.add('text-blue-700', 'border-blue-600');
                    searchBtn.classList.remove('text-gray-700', 'border-transparent');
                }
                if (searchContent) searchContent.classList.remove('hidden');
                if (imageGridContainer) imageGridContainer.classList.remove('hidden');
            } else if (tab === 'lists') {
                if (listsBtn) {
                    listsBtn.classList.add('text-blue-700', 'border-blue-600');
                    listsBtn.classList.remove('text-gray-700', 'border-transparent');
                }
                if (listsContent) listsContent.classList.remove('hidden');
                if (imageGridContainer) imageGridContainer.classList.add('hidden');
            }
        }
        // Default to Search tab on load, or Lists if hash is #lists
        document.addEventListener('DOMContentLoaded', () => {
            if (window.location.hash === '#lists') {
                showListsScreen();
            } else {
                showTab('search');
            }
        });

        function showGallery() {
            renderImages();
        }

        async function loadListItems(listId) {
            console.log('loadListItems called with', listId);
            const container = document.getElementById('listItemsContainer');
            if (!container) {
                console.log('listItemsContainer not found');
                return;
            }
            container.innerHTML = '<div class="col-span-full text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i> Loading...</div>';
            const resp = await fetch(`/api/v1/lists/${listId}/items`, { headers: { 'X-Tenant-ID': currentTenant } });
            console.log('list items fetch response', resp);
            const items = await resp.json();
            console.log('list items data', items);
            if (!items.length) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No photos in this list.</div>';
                return;
            }
            // For each item, fetch image details (could be optimized with batch API)
            const images = await Promise.all(items.map(async item => {
                const resp = await fetch(`/api/v1/images/${item.photo_id}`, { headers: { 'X-Tenant-ID': currentTenant } });
                const image = await resp.json();
                return { image, item };
            }));
            console.log('list images', images);
            if (window.listDisplayMode === 'list') {
                container.className = '';
                const html = images.map(({image, item}) => renderListImageRow(image, item)).join('');
                console.log('list row HTML', html);
                container.innerHTML = html;
            } else {
                container.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
                const html = images.map(({image, item}) => renderListImageCard(image, item)).join('');
                console.log('list card HTML', html);
                container.innerHTML = html;
            }
        }

        // ...existing code...
        function renderListImageCard(image, item) {
            // Use the same logic as the main page for thumbnails
            const thumbUrl = image.thumbnail_url || `/api/v1/images/${image.id}/thumbnail`;
            return `<div class='image-card bg-white rounded-lg shadow overflow-hidden relative'>
                <img src='${thumbUrl}' alt='${image.filename}' class='w-full h-48 object-cover'>
                <div class='p-3'>
                    <div class='font-semibold text-gray-800 truncate'>${image.filename}</div>
                    <div class='text-xs text-gray-500 truncate mb-2'>${image.dropbox_path}</div>
                    <button onclick='removePhotoFromList(${item.id})' class='absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs'><i class='fas fa-trash'></i></button>
                </div>
            </div>`;
        }

        function renderListImageRow(image, item) {
            // ...existing code...
            const thumbUrl = image.thumbnail_url || `/api/v1/images/${image.id}/thumbnail`;
            return `<div class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b">
                <img src="${thumbUrl}" alt="${image.filename}" class="w-20 h-20 object-cover rounded shadow mr-4 flex-shrink-0">
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-gray-800 truncate">${image.filename}</div>
                    <div class="text-xs text-gray-500 truncate">${image.dropbox_path}</div>
                </div>
                <button onclick="removePhotoFromList(${item.id})" class="ml-4 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded shadow text-xs flex items-center"><i class="fas fa-trash mr-1"></i> Remove</button>
            </div>`;
        }

        // Returns the correct image URL for a given image and type ('thumbnail', 'full', etc.)
        function getImageUrl(image, type) {
            // If image has a cloud URL for the thumbnail, use it
            if (type === 'thumbnail' && image.thumbnail_url) {
                return image.thumbnail_url;
            }
            // If image has a GCS or HTTP(S) path for the thumbnail, use it
            if (type === 'thumbnail' && image.thumbnail_path && (image.thumbnail_path.startsWith('http://') || image.thumbnail_path.startsWith('https://') || image.thumbnail_path.startsWith('gs://'))) {
                return image.thumbnail_path.replace('gs://', 'https://storage.googleapis.com/');
            }
            // Fallback to API endpoint
            return `/api/v1/images/${image.id}/thumbnail`;
        }

        // List display mode state and toggle
        window.listDisplayMode = window.listDisplayMode || 'grid';
        function setListDisplayMode(mode) {
            window.listDisplayMode = mode;
            // Update button active states
            document.getElementById('listGridModeBtn').classList.toggle('bg-blue-100', mode === 'grid');
            document.getElementById('listListModeBtn').classList.toggle('bg-blue-100', mode === 'list');
            // Reload items
            const activeListId = document.getElementById('listTitleInput') ? parseInt(document.getElementById('listTitleInput').closest('div.bg-white').querySelector('button[onclick^="saveListMeta"]').getAttribute('onclick').match(/\d+/)[0]) : null;
            if (activeListId) loadListItems(activeListId);
        }

        async function removePhotoFromList(itemId) {
            if (!confirm('Remove this photo from the list?')) return;
    const resp = await fetch(`/api/v1/lists/items/${itemId}`, { method: 'DELETE', headers: { 'X-Tenant-ID': currentTenant } });
    if (resp.ok) {
        // Refresh the current list view if available
        if (window.currentListViewId) {
            viewList(window.currentListViewId);
        } else {
            showListsScreen();
        }
    } else {
        alert('Failed to remove photo from list.');
    }
}
        
        async function saveListMeta(listId) {
            const title = document.getElementById('listTitleInput').value;
            const notebox = document.getElementById('listNoteboxInput').value;
            const resp = await fetch(`/api/v1/lists/${listId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'X-Tenant-ID': currentTenant },
                body: JSON.stringify({ title, notebox })
            });
            if (resp.ok) {
                alert('List updated!');
            } else {
                alert('Failed to update list.');
            }
        }

        async function createActiveList() {
            const resp = await fetch('/api/v1/lists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Tenant-ID': currentTenant },
                body: JSON.stringify({ title: 'New List', is_active: true })
            });
            if (resp.ok) {
                showListsScreen();
            } else {
                alert('Failed to create list.');
            }
        }
        </script>

        <!-- Sync Status -->
        <div id="syncStatus" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                <div>
                    <div id="syncStatusText" class="text-sm text-gray-700"></div>
                </div>
            </div>
        </div>

        <!-- Image Gallery -->
        <div class="max-w-7xl mx-auto px-4">
            <div id="imageGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Images will be loaded here -->
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-8 hidden">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
            <p class="mt-2 text-gray-600">Loading images...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16 hidden">
            <i class="fas fa-images text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No images yet</h3>
            <p class="text-gray-500">Upload some images to get started</p>
        </div>
    </div>

    <!-- Image Detail Modal -->
    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-6xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <img id="modalImage" src="" alt="" class="w-full rounded-lg shadow-lg">
                    </div>
                    <div>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Details</h3>
                                <div id="imageDetails" class="text-sm text-gray-600 space-y-1">
                                    <!-- Details will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Camera Info</h3>
                                <div id="cameraInfo" class="text-sm text-gray-600 space-y-1">
                                    <!-- Camera info will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer hover:text-gray-900 flex items-center" onclick="toggleExifDetails()">
                                    <i id="exifDetailsIcon" class="fas fa-chevron-right mr-2 text-sm transition-transform"></i>
                                    <span>EXIF Metadata</span>
                                </h3>
                                <div id="exifDetailsSection" class="hidden">
                                    <div id="exifMetadata" class="text-xs text-gray-600 space-y-1 ml-4 mt-2 max-h-64 overflow-y-auto">
                                        <!-- EXIF metadata will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer hover:text-gray-900 flex items-center" onclick="toggleDropboxProperties()">
                                    <i id="dropboxPropertiesIcon" class="fas fa-chevron-right mr-2 text-sm transition-transform"></i>
                                    <span>Dropbox Properties</span>
                                </h3>
                                <div id="dropboxPropertiesSection" class="hidden">
                                    <div id="dropboxProperties" class="text-xs text-gray-600 space-y-1 ml-4 mt-2 max-h-64 overflow-y-auto">
                                        <!-- Dropbox properties will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Current Tags</h3>
                                <div class="text-xs text-gray-500 mb-2 flex items-center gap-4">
                                    <span class="flex items-center gap-1">
                                        <span class="inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">ML</span>
                                        <span>Machine-generated</span>
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full">✓</span>
                                        <span>Manually approved</span>
                                    </span>
                                </div>
                                <div id="currentTags" class="flex flex-wrap gap-2">
                                    <!-- Current active tags will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2 cursor-pointer hover:text-gray-900 flex items-center" onclick="toggleTagDetails()">
                                    <i id="tagDetailsIcon" class="fas fa-chevron-right mr-2 text-sm transition-transform"></i>
                                    <span>Tag Details</span>
                                </h3>
                                <div id="tagDetailsSection" class="hidden">
                                    <div class="ml-4 space-y-4 mt-2">
                                        <div>
                                            <h4 class="font-medium text-gray-600 mb-1 text-sm">Machine Generated Tags</h4>
                                            <p class="text-xs text-gray-500 mb-2">All ML-generated tags with confidence scores and dates. <span class="line-through">Strikethrough</span> indicates tags rejected by permatags.</p>
                                            <div id="imageTags" class="flex flex-wrap gap-2">
                                                <!-- All machine tags will be loaded here -->
                                            </div>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-600 mb-1 text-sm flex justify-between items-center">
                                                <span>Permatags - Tag Overrides</span>
                                                <button onclick="acceptAllTags()" id="acceptAllBtn" 
                                                        class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded transition-colors">
                                                    <i class="fas fa-check mr-1"></i>Accept All
                                                </button>
                                            </h4>
                                            <p class="text-xs text-gray-500 mb-2">Manual tag decisions (✓ approved, − rejected) that persist across retagging.</p>
                                            <div id="imagePermatags" class="flex flex-wrap gap-2 mb-3">
                                                <!-- Permatags will be loaded here -->
                                            </div>
                                            <div class="flex gap-2 mt-2">
                                                <input type="text" id="newPermatagKeyword" placeholder="Add keyword..." 
                                                       class="text-sm border border-gray-300 rounded px-2 py-1 flex-1">
                                                <select id="newPermatagSignum" class="text-sm border border-gray-300 rounded px-2 py-1">
                                                    <option value="1">✓ Approve</option>
                                                    <option value="-1">✗ Reject</option>
                                                </select>
                                                <button onclick="addPermatag()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded transition-colors">
                                                    Add
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">People</h3>
                                <div id="imagePeople" class="flex flex-wrap gap-2">
                                    <!-- People will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Upload Images</h2>
                    <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">Drag and drop images here or click to browse</p>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        Select Files
                    </button>
                </div>
                <div id="uploadProgress" class="mt-4 hidden">
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="uploadStatus" class="text-center mt-2 text-gray-600"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Lists Modal logic
    function openListsModal() {
        document.getElementById('listsModal').classList.remove('hidden');
        fetchAndRenderLists();
    }
    function closeListsModal() {
        document.getElementById('listsModal').classList.add('hidden');
    }
    async function fetchAndRenderLists() {
        const container = document.getElementById('listsContainer');
        const loading = document.getElementById('listsLoading');
        const error = document.getElementById('listsError');
        container.innerHTML = '';
        error.classList.add('hidden');
        loading.classList.remove('hidden');
        try {
            const resp = await fetch('/api/v1/lists', {
                headers: { 'X-Tenant-ID': currentTenant }
            });
            if (!resp.ok) throw new Error('Failed to fetch lists');
            const lists = await resp.json();
            loading.classList.add('hidden');
            if (!lists.length) {
                container.innerHTML = '<li class="text-gray-500 py-4 text-center">No lists found.</li>';
                return;
            }
            container.innerHTML = lists.map(l => `
                <li class="py-3 px-2 flex flex-col">
                    <span class="font-semibold">${l.title}</span>
                    <span class="text-xs text-gray-500">${l.is_active ? '<span class=\'text-green-600\'>Active</span>' : 'Inactive'} | Created: ${l.created_at ? new Date(l.created_at).toLocaleString() : ''}</span>
                    <span class="text-gray-600 text-sm mt-1">${l.notebox || ''}</span>
                </li>
            `).join('');
        } catch (err) {
            loading.classList.add('hidden');
            error.textContent = 'Failed to load lists.';
            error.classList.remove('hidden');
        }
    }
        let currentTenant = 'bcg';
        let currentImages = [];
        let selectedKeywords = new Set();
        let selectedKeywordsByCategory = {}; // Track which category each keyword belongs to
        let categoryOperators = {}; // Track OR/AND operator per category
        let availableKeywords = {};

        // Get current tagging model from localStorage or use default
        function getCurrentModel() {
            return localStorage.getItem('taggingModel') || 'siglip';
        }

        // Update model display
        function updateModelDisplay() {
            const model = getCurrentModel();
            const displayEl = document.getElementById('current-model-display');
            if (displayEl) {
                displayEl.textContent = model;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateModelDisplay();
        });

        // Update display when navigating back to the page
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updateModelDisplay();
            }
        });

        // Also update on focus (when clicking back to the tab/window)
        window.addEventListener('focus', () => {
            updateModelDisplay();
        });

        function openConfig() {
            window.location.href = `/static/config.html?tenant=${currentTenant}`;
        }

        async function loadKeywords() {
            try {
                const response = await fetch('/api/v1/keywords', {
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });

                if (!response.ok) {
                    console.error('Failed to load keywords');
                    return;
                }

                const data = await response.json();
                availableKeywords = data.keywords_by_category;

                // Initialize category tracking
                for (const category in availableKeywords) {
                    if (!selectedKeywordsByCategory[category]) {
                        selectedKeywordsByCategory[category] = new Set();
                    }
                    if (!categoryOperators[category]) {
                        categoryOperators[category] = 'OR'; // Default to OR
                    }
                }

                // Render category input fields
                renderCategoryInputs();
            } catch (error) {
                console.error('Error loading keywords:', error);
            }
        }

        function renderCategoryInputs() {
            const container = document.getElementById('categoryInputsContainer');
            container.innerHTML = '';

            for (const [category, keywords] of Object.entries(availableKeywords)) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'space-y-1';

                // Category label with operator toggle
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between';

                const label = document.createElement('label');
                label.className = 'text-xs font-semibold text-gray-600 uppercase';
                label.textContent = category;

                const operatorButton = document.createElement('button');
                operatorButton.id = `operator-${category}`;
                operatorButton.className = 'px-2 py-0.5 rounded bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700';
                operatorButton.textContent = categoryOperators[category] || 'OR';
                operatorButton.onclick = () => toggleCategoryOperator(category);

                headerDiv.appendChild(label);
                headerDiv.appendChild(operatorButton);
                categoryDiv.appendChild(headerDiv);

                // Tag input container with relative positioning for dropdown
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'relative';

                // Tags container
                const tagsContainer = document.createElement('div');
                tagsContainer.id = `tags-${category}`;
                tagsContainer.className = 'min-h-[42px] border rounded-lg p-2 bg-white flex flex-wrap gap-2 items-center cursor-text';
                tagsContainer.onclick = () => document.getElementById(`input-${category}`).focus();

                // Input field
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `input-${category}`;
                input.placeholder = `Type to search ${category}...`;
                input.className = 'flex-1 min-w-[200px] outline-none text-sm';
                input.autocomplete = 'off';
                input.oninput = (e) => handleCategoryInput(category, e);
                input.onkeydown = (e) => handleCategoryKeydown(category, e);
                input.onfocus = () => showCategoryDropdown(category);

                tagsContainer.appendChild(input);
                inputWrapper.appendChild(tagsContainer);

                // Dropdown
                const dropdown = document.createElement('div');
                dropdown.id = `dropdown-${category}`;
                dropdown.className = 'hidden absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-64 overflow-y-auto';
                inputWrapper.appendChild(dropdown);

                categoryDiv.appendChild(inputWrapper);
                container.appendChild(categoryDiv);
            }
        }

        function renderCategoryDropdown(category, filterText = '') {
            const dropdown = document.getElementById(`dropdown-${category}`);
            if (!dropdown) return;

            dropdown.innerHTML = '';

            const filter = filterText.toLowerCase();
            const keywords = availableKeywords[category] || [];
            const selectedInCategory = selectedKeywordsByCategory[category] || new Set();

            // Filter keywords by search text and exclude already selected
            const filteredKeywords = keywords.filter(kwObj => {
                const keyword = kwObj.keyword || kwObj;
                return keyword.toLowerCase().includes(filter) && !selectedInCategory.has(keyword);
            });

            if (filteredKeywords.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'px-3 py-4 text-sm text-gray-500 text-center';
                noResults.textContent = filterText ? 'No matching keywords found' : 'No more keywords available';
                dropdown.appendChild(noResults);
                return;
            }

            // Keywords
            filteredKeywords.forEach(kwObj => {
                const keyword = kwObj.keyword || kwObj;
                const count = kwObj.count || 0;

                const item = document.createElement('div');
                item.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer flex justify-between items-center';
                item.onclick = () => addCategoryKeyword(category, keyword);

                const keywordSpan = document.createElement('span');
                keywordSpan.className = 'text-sm';
                keywordSpan.textContent = keyword;

                const countSpan = document.createElement('span');
                countSpan.className = 'text-xs text-gray-400';
                countSpan.textContent = `(${count})`;

                item.appendChild(keywordSpan);
                item.appendChild(countSpan);
                dropdown.appendChild(item);
            });
        }

        function showCategoryDropdown(category) {
            // Load keywords if not already loaded
            if (Object.keys(availableKeywords).length === 0) {
                loadKeywords().then(() => {
                    renderCategoryDropdown(category);
                    const dropdown = document.getElementById(`dropdown-${category}`);
                    if (dropdown) dropdown.classList.remove('hidden');
                });
            } else {
                renderCategoryDropdown(category);
                const dropdown = document.getElementById(`dropdown-${category}`);
                if (dropdown) dropdown.classList.remove('hidden');
            }
        }

        function hideCategoryDropdown(category) {
            const dropdown = document.getElementById(`dropdown-${category}`);
            if (dropdown) dropdown.classList.add('hidden');
        }

        function handleCategoryInput(category, event) {
            const filterText = event.target.value;
            renderCategoryDropdown(category, filterText);
            showCategoryDropdown(category);
        }

        function handleCategoryKeydown(category, event) {
            const input = event.target;

            // Backspace on empty input removes last tag in this category
            if (event.key === 'Backspace' && input.value === '') {
                const categorySet = selectedKeywordsByCategory[category];
                if (categorySet && categorySet.size > 0) {
                    const lastKeyword = Array.from(categorySet).pop();
                    removeCategoryKeyword(category, lastKeyword);
                }
            }

            // Escape closes dropdown
            if (event.key === 'Escape') {
                hideCategoryDropdown(category);
            }
        }

        function addCategoryKeyword(category, keyword) {
            if (!selectedKeywordsByCategory[category]) {
                selectedKeywordsByCategory[category] = new Set();
            }
            selectedKeywordsByCategory[category].add(keyword);
            selectedKeywords.add(keyword);

            renderCategoryTags(category);
            updateFilterCount();
            loadImages();

            // Clear input and update dropdown
            const input = document.getElementById(`input-${category}`);
            if (input) {
                input.value = '';
                renderCategoryDropdown(category);
                input.focus();
            }
        }

        function removeCategoryKeyword(category, keyword) {
            if (selectedKeywordsByCategory[category]) {
                selectedKeywordsByCategory[category].delete(keyword);
            }
            selectedKeywords.delete(keyword);

            renderCategoryTags(category);
            updateFilterCount();
            loadImages();
            renderCategoryDropdown(category);
        }

        function renderCategoryTags(category) {
            const container = document.getElementById(`tags-${category}`);
            const input = document.getElementById(`input-${category}`);
            if (!container || !input) return;

            // Clear existing tags (but keep the input)
            const existingTags = container.querySelectorAll('.keyword-tag');
            existingTags.forEach(tag => tag.remove());

            // Add tags before input
            const categorySet = selectedKeywordsByCategory[category] || new Set();
            categorySet.forEach(keyword => {
                const tag = document.createElement('span');
                tag.className = 'keyword-tag inline-flex items-center gap-1 bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm';

                const text = document.createElement('span');
                text.textContent = keyword;

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '×';
                removeBtn.className = 'hover:bg-blue-200 rounded-full w-4 h-4 flex items-center justify-center';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeCategoryKeyword(category, keyword);
                };

                tag.appendChild(text);
                tag.appendChild(removeBtn);
                container.insertBefore(tag, input);
            });
        }

        function toggleCategoryOperator(category) {
            categoryOperators[category] = categoryOperators[category] === 'OR' ? 'AND' : 'OR';
            const button = document.getElementById(`operator-${category}`);
            if (button) {
                button.textContent = categoryOperators[category];
            }

            // Reload images if this category has selected keywords
            const categorySet = selectedKeywordsByCategory[category];
            if (categorySet && categorySet.size > 0) {
                loadImages();
            }
        }

        function updateFilterCount() {
            const count = selectedKeywords.size;
            const badge = document.getElementById('activeFiltersCount');

            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function clearFilters() {
            selectedKeywords.clear();
            selectedKeywordsByCategory = {};
            categoryOperators = {};

            // Re-initialize category sets and operators
            for (const category in availableKeywords) {
                selectedKeywordsByCategory[category] = new Set();
                categoryOperators[category] = 'OR';
                renderCategoryTags(category);
                renderCategoryDropdown(category);

                // Update operator button
                const button = document.getElementById(`operator-${category}`);
                if (button) {
                    button.textContent = 'OR';
                }
            }

            updateFilterCount();
            loadImages();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            for (const category in availableKeywords) {
                const dropdown = document.getElementById(`dropdown-${category}`);
                const container = document.getElementById(`tags-${category}`);

                if (dropdown && container) {
                    if (!dropdown.contains(e.target) && !container.contains(e.target)) {
                        hideCategoryDropdown(category);
                    }
                }
            }
        });


        // --- Display Mode State ---
        let displayMode = localStorage.getItem('displayMode') || 'grid';

        function setDisplayMode(mode) {
            displayMode = mode;
            localStorage.setItem('displayMode', mode);
            updateDisplayModeButtons();
            renderImages();
        }

        function updateDisplayModeButtons() {
            const gridBtn = document.getElementById('gridModeBtn');
            const listBtn = document.getElementById('listModeBtn');
            if (!gridBtn || !listBtn) return;
            if (displayMode === 'grid') {
                gridBtn.classList.add('bg-blue-100', 'text-blue-700');
                listBtn.classList.remove('bg-blue-100', 'text-blue-700');
            } else {
                listBtn.classList.add('bg-blue-100', 'text-blue-700');
                gridBtn.classList.remove('bg-blue-100', 'text-blue-700');
            }
        }

        function renderImages() {
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            if (currentImages.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            } else {
                document.getElementById('emptyState').classList.add('hidden');
            }
            if (displayMode === 'grid') {
                imageGrid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
                currentImages.forEach(image => {
                    const card = createImageCard(image);
                    imageGrid.appendChild(card);
                });
            } else {
                imageGrid.className = 'divide-y divide-gray-200';
                renderImageList(imageGrid, currentImages);
            }
        }

        function renderImageList(container, images) {
            images.forEach(image => {
                const row = document.createElement('div');
                row.className = 'flex items-center p-3 hover:bg-gray-50 cursor-pointer';
                row.onclick = () => showImageDetail(image);

                // Thumbnail
                const thumb = document.createElement('img');
                thumb.src = image.thumbnail_url || `/api/v1/images/${image.id}/thumbnail`;
                thumb.alt = image.filename;
                thumb.className = 'w-20 h-20 object-cover rounded shadow mr-4 flex-shrink-0';
                thumb.onerror = function() {
                    this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 400%22%3E%3Crect fill=%22%23ddd%22 width=%22400%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22%3ENo Image%3C/text%3E%3C/svg%3E';
                };
                row.appendChild(thumb);

                // Info
                const info = document.createElement('div');
                info.className = 'flex-1 min-w-0';
                info.innerHTML = `
                    <div class="font-semibold text-gray-800 truncate">${image.filename}</div>
                    <div class="text-xs text-gray-500 truncate">${image.dropbox_path}</div>
                    <div class="flex flex-wrap gap-2 mt-1">
                        ${getTagBadges(image)}
                    </div>
                `;
                row.appendChild(info);

                // Add to List button
                const addBtn = document.createElement('button');
                addBtn.className = 'ml-4 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded shadow text-xs flex items-center';
                addBtn.innerHTML = '<i class="fas fa-list mr-1"></i> Add to List';
                addBtn.onclick = (e) => { e.stopPropagation(); addPhotoToList(image.id, e); };
                row.appendChild(addBtn);

                // Dropbox link
                const dbx = document.createElement('a');
                dbx.href = `https://www.dropbox.com/home${encodeURIComponent(image.dropbox_path)}`;
                dbx.target = 'dropbox';
                dbx.onclick = e => e.stopPropagation();
                dbx.className = 'ml-4 text-blue-600 hover:text-blue-800 flex items-center';
                dbx.title = 'Open in Dropbox';
                dbx.innerHTML = '<i class="fab fa-dropbox fa-lg"></i>';
                row.appendChild(dbx);

                container.appendChild(row);
            });
        }

        function getTagBadges(image) {
            // Build permatag map
            const permatagMap = {};
            if (image.permatags) {
                image.permatags.forEach(p => {
                    permatagMap[p.keyword] = p.signum;
                });
            }
            // Get current tags: machine tags NOT negatively permatagged + positive permatags
            const currentTags = [];
            if (image.tags) {
                image.tags.forEach(tag => {
                    if (permatagMap[tag.keyword] !== -1) {
                        currentTags.push({
                            keyword: tag.keyword,
                            category: tag.category,
                            confidence: tag.confidence,
                            source: 'machine'
                        });
                    }
                });
            }
            if (image.permatags) {
                image.permatags.forEach(p => {
                    if (p.signum === 1) {
                        const alreadyInMachine = image.tags && image.tags.some(t => t.keyword === p.keyword);
                        if (!alreadyInMachine) {
                            currentTags.push({
                                keyword: p.keyword,
                                category: p.category,
                                source: 'permatag'
                            });
                        }
                    }
                });
            }
            return currentTags.map(tag => {
                const isInPermatags = permatagMap.hasOwnProperty(tag.keyword);
                const bgColor = isInPermatags ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                const confidenceText = tag.confidence ? ` <span class="text-xs text-gray-500">(${Math.round(tag.confidence * 100)}%)</span>` : '';
                return `<span class="inline-block ${bgColor} px-2 py-0.5 rounded-full text-xs">${tag.keyword}${confidenceText}</span>`;
            }).join(' ');
        }

        async function loadImages() {
            const loading = document.getElementById('loading');
            const imageGrid = document.getElementById('imageGrid');
            const emptyState = document.getElementById('emptyState');

            loading.classList.remove('hidden');
            imageGrid.innerHTML = '';
            emptyState.classList.add('hidden');

            try {
                // Build query parameters
                const params = new URLSearchParams();

                // Add keyword filters with per-category operators
                if (selectedKeywords.size > 0) {
                    // Build category filter data
                    const categoryFilters = {};
                    for (const [category, keywords] of Object.entries(selectedKeywordsByCategory)) {
                        if (keywords && keywords.size > 0) {
                            categoryFilters[category] = {
                                keywords: Array.from(keywords),
                                operator: categoryOperators[category] || 'OR'
                            };
                        }
                    }
                    params.append('category_filters', JSON.stringify(categoryFilters));
                }

                const response = await fetch(`/api/v1/images?${params.toString()}`, {
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                currentImages = data.images || [];

                loading.classList.add('hidden');

                renderImages();
                updateStats(data);
            } catch (error) {
                console.error('Error loading images:', error);
                alert('Error loading images: ' + error.message + '\nCheck console for details.');
                loading.classList.add('hidden');
                emptyState.classList.remove('hidden');
            }
        }

        function createImageCard(image) {
            const div = document.createElement('div');
            div.className = 'image-card bg-white rounded-lg shadow overflow-hidden cursor-pointer';
            div.onclick = () => showImageDetail(image);

            // Build permatag map
            const permatagMap = {};
            if (image.permatags) {
                image.permatags.forEach(p => {
                    permatagMap[p.keyword] = p.signum;
                });
            }

            // Get current tags: machine tags NOT negatively permatagged + positive permatags
            const currentTags = [];

            // Add machine tags that aren't negatively permatagged
            if (image.tags) {
                image.tags.forEach(tag => {
                    if (permatagMap[tag.keyword] !== -1) {
                        currentTags.push({
                            keyword: tag.keyword,
                            category: tag.category,
                            confidence: tag.confidence,
                            source: 'machine'
                        });
                    }
                });
            }

            // Add positive permatags not already in machine tags
            if (image.permatags) {
                image.permatags.forEach(p => {
                    if (p.signum === 1) {
                        const alreadyInMachine = image.tags && image.tags.some(t => t.keyword === p.keyword);
                        if (!alreadyInMachine) {
                            currentTags.push({
                                keyword: p.keyword,
                                category: p.category,
                                source: 'permatag'
                            });
                        }
                    }
                });
            }

            // Group current tags by category
            let tagsHTML = '';
            if (currentTags.length > 0) {
                const byCategory = {};
                currentTags.forEach(tag => {
                    if (!byCategory[tag.category]) {
                        byCategory[tag.category] = [];
                    }
                    byCategory[tag.category].push(tag);
                });

                // Define category order
                const categoryOrder = ['Circus Skills', 'Costume Colors'];
                const sortedCategories = categoryOrder.filter(cat => byCategory[cat]);

                const categoryLines = sortedCategories.map(category => {
                    const tags = byCategory[category];
                    const tagsList = tags.map(t => {
                        const confidenceText = t.confidence ? ` (${Math.round(t.confidence * 100)}%)` : '';
                        return `${t.keyword}${confidenceText}`;
                    }).join(', ');
                    return `<div class="text-xs text-gray-600"><strong>${category}:</strong> ${tagsList}</div>`;
                }).join('');

                tagsHTML = `<div class="mt-2">${categoryLines}</div>`;
            }
            
            div.innerHTML = `
                <div class="aspect-square bg-gray-200 relative">
                    <img src="${image.thumbnail_url || `/api/v1/images/${image.id}/thumbnail`}" 
                         alt="${image.filename}" 
                         class="w-full h-full object-cover"
                         loading="lazy"
                         onerror="this.src=&quot;data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 400%22%3E%3Crect fill=%22%23ddd%22 width=%22400%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22%3ENo Image%3C/text%3E%3C/svg%3E&quot;">
                    <a href="https://www.dropbox.com/home${encodeURIComponent(image.dropbox_path)}"
                       target="dropbox"
                       onclick="event.stopPropagation()"
                       class="absolute top-2 left-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-lg transition-colors"
                       title="Open in Dropbox">
                        <i class="fab fa-dropbox"></i>
                    </a>
                    <button onclick="reprocessImage(${image.id}, event)"
                       class="absolute bottom-2 right-2 bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded shadow-lg transition-colors text-xs"
                       title="Reprocess this image with current keywords">
                        <i class="fas fa-sync-alt"></i> Retag
                    </button>
                    <button onclick="event.stopPropagation(); addPhotoToList(${image.id}, event)"
                       class="absolute bottom-2 left-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded shadow-lg transition-colors text-xs"
                       title="Add to List">
                        <i class="fas fa-list"></i> Add to List
                    </button>
                    ${image.tags_applied ? '<div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs"><i class="fas fa-tag"></i></div>' : ''}
                </div>
                <div class="p-3">
                    <p class="font-semibold text-gray-800 truncate">${image.filename}</p>
                    <p class="text-sm text-gray-500">${image.width} × ${image.height}</p>
                    <p class="text-xs text-gray-400"><i class="far fa-clock"></i> ${image.modified_time ? new Date(image.modified_time).toLocaleDateString() : 'Unknown'}</p>
                    ${image.capture_timestamp ? `<p class="text-xs text-gray-400"><i class="far fa-calendar"></i> Photo: ${new Date(image.capture_timestamp).toLocaleDateString()}</p>` : ''}
                    ${image.camera_model ? `<p class="text-xs text-gray-400 truncate">${image.camera_model}</p>` : ''}
                    ${tagsHTML}
                </div>
            `;
            
            return div;
        }

        async function showImageDetail(image) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalTitle').textContent = image.filename;
            document.getElementById('modalImage').src = image.thumbnail_url || `/api/v1/images/${image.id}/thumbnail`;
            
            // Store current image ID for permatag operations
            window.currentImageId = image.id;
            
            // Fetch full details including tags
            try {
                const response = await fetch(`/api/v1/images/${image.id}`, {
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });
                const details = await response.json();
                
                // Store details for reference
                window.currentImageDetails = details;
                
                // Details
                const detailsDiv = document.getElementById('imageDetails');
                detailsDiv.innerHTML = `
                    <div><strong>Size:</strong> ${details.width} × ${details.height}</div>
                    <div><strong>Format:</strong> ${details.format || 'Unknown'}</div>
                    <div><strong>File Size:</strong> ${formatBytes(details.file_size)}</div>
                    <div><strong>Path:</strong> ${details.dropbox_path}</div>
                    <div class="mt-3 space-y-2">
                        <a href="https://www.dropbox.com/home${encodeURIComponent(details.dropbox_path)}"
                           target="dropbox"
                           class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fab fa-dropbox mr-2"></i>Open in Dropbox
                        </a>
                        <button onclick="reprocessImageFromModal(${image.id})"
                           id="modalRetagButton"
                           class="inline-flex items-center bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors ml-2">
                            <i class="fas fa-sync-alt mr-2"></i>Retag
                        </button>
                        <button onclick="analyzeImageScores(${image.id})"
                           id="modalAnalyzeButton"
                           class="inline-flex items-center bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors ml-2">
                            <i class="fas fa-chart-bar mr-2"></i>Show All Scores
                        </button>
                        <button onclick="addPhotoToList(${image.id}, event)"
                           id="modalAddToListButton"
                           class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors ml-2">
                            <i class="fas fa-list mr-2"></i>Add to List
                        </button>
                    </div>
                    <div id="analysisResults" class="mt-4 hidden">
                        <!-- Analysis results will be shown here -->
                    </div>
                `;
                
                // Camera info
                const camera = document.getElementById('cameraInfo');
                camera.innerHTML = details.camera_make ? `
                    <div><strong>Make:</strong> ${details.camera_make}</div>
                    <div><strong>Model:</strong> ${details.camera_model}</div>
                    ${details.lens_model ? `<div><strong>Lens:</strong> ${details.lens_model}</div>` : ''}
                    ${details.iso ? `<div><strong>ISO:</strong> ${details.iso}</div>` : ''}
                    ${details.aperture ? `<div><strong>Aperture:</strong> f/${details.aperture}</div>` : ''}
                ` : '<div class="text-gray-400">No camera information</div>';

                // EXIF metadata
                const exifDiv = document.getElementById('exifMetadata');
                if (details.exif_data && Object.keys(details.exif_data).length > 0) {
                    // Sort EXIF keys alphabetically for easier browsing
                    const sortedKeys = Object.keys(details.exif_data).sort();
                    exifDiv.innerHTML = sortedKeys.map(key => {
                        const value = details.exif_data[key];
                        // Format the value nicely
                        let displayValue;
                        if (Array.isArray(value)) {
                            displayValue = value.join(', ');
                        } else if (typeof value === 'object' && value !== null) {
                            displayValue = JSON.stringify(value);
                        } else {
                            displayValue = String(value);
                        }
                        // Truncate very long values
                        if (displayValue.length > 100) {
                            displayValue = displayValue.substring(0, 100) + '...';
                        }
                        return `<div class="py-1 border-b border-gray-100"><strong class="text-gray-700">${key}:</strong> <span class="text-gray-600">${displayValue}</span></div>`;
                    }).join('');
                } else {
                    exifDiv.innerHTML = '<div class="text-gray-400">No EXIF metadata available</div>';
                }

                // Dropbox properties
                const dropboxPropsDiv = document.getElementById('dropboxProperties');
                if (details.dropbox_properties && Object.keys(details.dropbox_properties).length > 0) {
                    // Sort property keys alphabetically
                    const sortedKeys = Object.keys(details.dropbox_properties).sort();
                    dropboxPropsDiv.innerHTML = sortedKeys.map(key => {
                        const value = details.dropbox_properties[key];
                        // Format the value nicely
                        let displayValue;
                        if (Array.isArray(value)) {
                            displayValue = value.join(', ');
                        } else if (typeof value === 'object' && value !== null) {
                            displayValue = JSON.stringify(value);
                        } else {
                            displayValue = String(value);
                        }
                        // Truncate very long values
                        if (displayValue.length > 100) {
                            displayValue = displayValue.substring(0, 100) + '...';
                        }
                        // Clean up property key display (remove template ID prefix if present)
                        const displayKey = key.includes('.') ? key.split('.').slice(1).join('.') : key;
                        return `<div class="py-1 border-b border-gray-100"><strong class="text-gray-700">${displayKey}:</strong> <span class="text-gray-600">${displayValue}</span></div>`;
                    }).join('');
                } else {
                    dropboxPropsDiv.innerHTML = '<div class="text-gray-400">No Dropbox custom properties</div>';
                }

                // Build permatag lookup maps
                const permatagMap = {};
                if (details.permatags) {
                    details.permatags.forEach(p => {
                        permatagMap[p.keyword] = p.signum;
                    });
                }
                
                // 1. Current Tags (machine tags - negative permatags + positive permatags)
                const currentTagsDiv = document.getElementById('currentTags');
                const currentTags = [];
                
                // Add machine tags that aren't negatively permatagged
                if (details.tags) {
                    details.tags.forEach(tag => {
                        if (permatagMap[tag.keyword] !== -1) {
                            currentTags.push({
                                keyword: tag.keyword,
                                category: tag.category,
                                source: 'machine',
                                confidence: tag.confidence
                            });
                        }
                    });
                }
                
                // Add positive permatags
                if (details.permatags) {
                    details.permatags.forEach(p => {
                        if (p.signum === 1) {
                            // Check if it's not already in machine tags
                            const alreadyInMachine = details.tags && details.tags.some(t => t.keyword === p.keyword);
                            if (!alreadyInMachine) {
                                currentTags.push({
                                    keyword: p.keyword,
                                    category: p.category,
                                    source: 'permatag'
                                });
                            }
                        }
                    });
                }
                
                if (currentTags.length > 0) {
                    currentTagsDiv.innerHTML = currentTags.map(tag => {
                        // Green if tag is in permatags (regardless of source), blue if only in machine tags
                        const isInPermatags = permatagMap.hasOwnProperty(tag.keyword);
                        const bgColor = isInPermatags ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                        const confidenceText = tag.confidence ? ` <span class="text-xs text-gray-500">(${Math.round(tag.confidence * 100)}%)</span>` : '';
                        return `<span class="inline-block ${bgColor} px-3 py-1 rounded-full text-sm">
                            ${tag.keyword}${confidenceText}
                        </span>`;
                    }).join(' ');
                } else {
                    currentTagsDiv.innerHTML = '<div class="text-gray-400">No active tags</div>';
                }
                
                // 2. Machine Generated Tags (all image_tags with dates)
                const tagsDiv = document.getElementById('imageTags');
                if (details.tags && details.tags.length > 0) {
                    tagsDiv.innerHTML = details.tags.map(tag => {
                        const dateStr = tag.created_at ? new Date(tag.created_at).toLocaleDateString() : 'Unknown';
                        const isRejected = permatagMap[tag.keyword] === -1;
                        
                        if (isRejected) {
                            // Show with strikethrough, no reject button
                            return `<span class="inline-block bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm">
                                <span class="line-through" title="Rejected by permatag">
                                    ${tag.keyword} <span class="text-xs text-gray-400">(${Math.round(tag.confidence * 100)}% • ${dateStr})</span>
                                </span>
                            </span>`;
                        } else {
                            // Normal display with approve/reject buttons
                            return `<span class="inline-block bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors group relative">
                                <span onclick="promoteToPermatag('${tag.keyword}', '${tag.category || ''}', 1)" class="cursor-pointer" title="Click to approve">
                                    ${tag.keyword} <span class="text-xs text-gray-500">(${Math.round(tag.confidence * 100)}% • ${dateStr})</span>
                                </span>
                                <button onclick="promoteToPermatag('${tag.keyword}', '${tag.category || ''}', -1); event.stopPropagation();" 
                                        class="ml-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:text-red-600"
                                        title="Reject this tag">
                                    −
                                </button>
                            </span>`;
                        }
                    }).join(' ');
                } else {
                    tagsDiv.innerHTML = '<div class="text-gray-400">No machine tags</div>';
                }
                
                // 3. Permatags (with dates)
                const permatagsDiv = document.getElementById('imagePermatags');
                
                if (details.permatags && details.permatags.length > 0) {
                    // Sort: positive (signum=1) first, negative (signum=-1) last
                    const sortedPermatags = [...details.permatags].sort((a, b) => b.signum - a.signum);
                    permatagsDiv.innerHTML = sortedPermatags.map(permatag => {
                        const isPositive = permatag.signum === 1;
                        const bgColor = isPositive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const icon = isPositive ? '✓' : '−';
                        const dateStr = permatag.created_at ? new Date(permatag.created_at).toLocaleDateString() : 'Unknown';
                        return `<span class="${bgColor} inline-block px-3 py-1 rounded-full text-sm relative group">
                            ${icon} ${permatag.keyword} <span class="text-xs opacity-75">(${dateStr})</span>
                            <button onclick="deletePermatag(${permatag.id})" 
                                    class="ml-2 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:text-red-600">
                                ×
                            </button>
                        </span>`;
                    }).join(' ');
                } else {
                    permatagsDiv.innerHTML = '<div class="text-gray-400 text-sm">No permatags yet</div>';
                }
                
                // People
                const peopleDiv = document.getElementById('imagePeople');
                peopleDiv.innerHTML = '<div class="text-gray-400">No people detected</div>';
                
            } catch (error) {
                console.error('Error loading image details:', error);
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
        }

        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                await uploadFiles(files);
            }
        });

        async function uploadFiles(files) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('uploadStatus');
            
            progressDiv.classList.remove('hidden');
            progressBar.classList.remove('bg-red-600');
            progressBar.classList.add('bg-blue-600');
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            
            statusText.textContent = `Uploading ${files.length} image(s)...`;
            progressBar.style.width = '50%';
            
            try {
                console.log('Uploading to tenant:', currentTenant);
                const model = getCurrentModel();
                const response = await fetch(`/api/v1/images/upload?model=${encodeURIComponent(model)}`, {
                    method: 'POST',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Upload result:', result);
                
                progressBar.style.width = '100%';
                statusText.textContent = `✓ Uploaded ${result.uploaded} image(s) successfully!`;
                
                // Reload images after a short delay
                setTimeout(() => {
                    closeUploadModal();
                    loadImages();
                }, 1500);
                
            } catch (error) {
                console.error('Upload error:', error);
                statusText.textContent = '✗ Upload failed: ' + error.message;
                progressBar.classList.remove('bg-blue-600');
                progressBar.classList.add('bg-red-600');
            }
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) {
                loadImages();
                return;
            }

            const filtered = currentImages.filter(img => {
                // Build permatag map for this image
                const permatagMap = {};
                if (img.permatags) {
                    img.permatags.forEach(p => {
                        permatagMap[p.keyword] = p.signum;
                    });
                }

                // Get current tags: machine tags NOT negatively permatagged + positive permatags
                const currentTags = [];

                // Add machine tags that aren't negatively permatagged
                if (img.tags) {
                    img.tags.forEach(tag => {
                        if (permatagMap[tag.keyword] !== -1) {
                            currentTags.push(tag.keyword);
                        }
                    });
                }

                // Add positive permatags not already in machine tags
                if (img.permatags) {
                    img.permatags.forEach(p => {
                        if (p.signum === 1) {
                            const alreadyInMachine = img.tags && img.tags.some(t => t.keyword === p.keyword);
                            if (!alreadyInMachine) {
                                currentTags.push(p.keyword);
                            }
                        }
                    });
                }

                // Search in current tags
                return currentTags.some(keyword =>
                    keyword.toLowerCase().includes(query)
                );
            });

            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            filtered.forEach(image => {
                const card = createImageCard(image);
                imageGrid.appendChild(card);
            });
        }

        function updateStats(data) {
            document.getElementById('totalImages').textContent = data.total || 0;
            document.getElementById('withFaces').textContent = '0'; // TODO
            document.getElementById('tagged').textContent = '0'; // TODO
            document.getElementById('storageUsed').textContent = '0 MB'; // TODO
        }

        async function reprocessImage(imageId, event) {
            // Stop propagation to prevent opening the image detail modal
            event.stopPropagation();

            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const model = getCurrentModel();
                const response = await fetch(`/api/v1/images/${imageId}/retag?model=${encodeURIComponent(model)}`, {
                    method: 'POST',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });

                if (!response.ok) {
                    throw new Error('Reprocessing failed');
                }

                const result = await response.json();
                console.log('Reprocess result:', result);

                // Show success briefly
                button.innerHTML = '<i class="fas fa-check"></i>';

                // Reload images to show updated tags
                setTimeout(() => {
                    loadImages();
                }, 500);

            } catch (error) {
                console.error('Reprocess error:', error);
                button.innerHTML = '<i class="fas fa-times"></i>';
                alert('✗ Reprocessing failed: ' + error.message);

                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }, 2000);
            }
        }

        async function reprocessImageFromModal(imageId) {
            const button = document.getElementById('modalRetagButton');
            const originalHTML = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Retagging...';

            try {
                const model = getCurrentModel();
                const response = await fetch(`/api/v1/images/${imageId}/retag?model=${encodeURIComponent(model)}`, {
                    method: 'POST',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });

                if (!response.ok) {
                    throw new Error('Reprocessing failed');
                }

                const result = await response.json();
                console.log('Reprocess result:', result);

                // Show success briefly
                button.innerHTML = '<i class="fas fa-check mr-2"></i>Complete!';

                // Reload the image details to show new tags
                setTimeout(async () => {
                    // Refetch the updated image data
                    const response = await fetch(`/api/v1/images/${imageId}`, {
                        headers: {
                            'X-Tenant-ID': currentTenant
                        }
                    });
                    const updatedImage = await response.json();

                    // Reload all image details (this updates both Current Tags and Machine Generated Tags)
                    await showImageDetail(updatedImage);

                    // Reload the main gallery to show updated tags on thumbnails
                    loadImages();

                    // Reset button
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }, 1000);

            } catch (error) {
                console.error('Reprocess error:', error);
                button.innerHTML = '<i class="fas fa-times mr-2"></i>Failed';
                alert('✗ Reprocessing failed: ' + error.message);

                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }, 2000);
            }
        }

        async function analyzeImageScores(imageId) {
            const button = document.getElementById('modalAnalyzeButton');
            const resultsDiv = document.getElementById('analysisResults');
            const originalHTML = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
            resultsDiv.classList.add('hidden');

            try {
                const response = await fetch(`/api/v1/images/${imageId}/analyze`, {
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });

                if (!response.ok) {
                    throw new Error('Analysis failed');
                }

                const result = await response.json();
                console.log('Analysis result:', result);

                // Backend returns scores_by_category as a dictionary
                const scoresByCategory = result.scores_by_category || {};

                // Build HTML for results
                let html = `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-semibold mb-3 text-gray-900">All Keyword Scores (Threshold: ${Math.round(result.threshold * 100)}%)</h4>
                `;

                // Sort categories alphabetically
                const sortedCategories = Object.keys(scoresByCategory).sort();

                sortedCategories.forEach(category => {
                    const scores = scoresByCategory[category];
                    // Sort by confidence descending
                    scores.sort((a, b) => b.confidence - a.confidence);

                    html += `
                        <div class="mb-4">
                            <h5 class="font-medium text-sm text-gray-700 mb-2">${category}</h5>
                            <div class="grid grid-cols-2 gap-2">
                    `;

                    scores.forEach(item => {
                        const percentage = Math.round(item.confidence * 100);
                        const isAboveThreshold = item.confidence >= result.threshold;
                        const badgeColor = isAboveThreshold ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600';
                        const icon = isAboveThreshold ? '✓' : '';

                        html += `
                            <div class="flex justify-between items-center ${badgeColor} px-2 py-1 rounded text-sm">
                                <span>${icon} ${item.keyword}</span>
                                <span class="font-mono text-xs">${percentage}%</span>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `
                        <div class="mt-3 text-xs text-gray-500">
                            <strong>Legend:</strong>
                            <span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded ml-2">✓ Above threshold (applied)</span>
                            <span class="inline-block bg-gray-100 text-gray-600 px-2 py-0.5 rounded ml-2">Below threshold</span>
                        </div>
                    </div>
                `;

                resultsDiv.innerHTML = html;
                resultsDiv.classList.remove('hidden');

                button.innerHTML = '<i class="fas fa-chart-bar mr-2"></i>Refresh Analysis';
                button.disabled = false;

            } catch (error) {
                console.error('Analysis error:', error);
                button.innerHTML = '<i class="fas fa-times mr-2"></i>Failed';
                alert('✗ Analysis failed: ' + error.message);

                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                }, 2000);
            }
        }

        async function retagAllImages() {
            const button = document.getElementById('retagButton');
            const originalText = button.innerHTML;

            if (!confirm('Retag all images with current keywords? This may take a few minutes.')) {
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Retagging...';

            try {
                const model = getCurrentModel();
                const response = await fetch(`/api/v1/retag?model=${encodeURIComponent(model)}`, {
                    method: 'POST',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });

                if (!response.ok) {
                    throw new Error('Retag failed');
                }

                const result = await response.json();
                alert(`✓ Retagging complete!\n\nProcessed: ${result.processed}/${result.total} images`);

                // Reload images to show new tags
                loadImages();

            } catch (error) {
                console.error('Retag error:', error);
                alert('✗ Retagging failed: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        let syncShouldStop = false;

        function connectDropbox() {
            const tenantId = document.getElementById('tenantSelect').value;
            // Open OAuth flow in new window
            window.open(`/oauth/dropbox/authorize?tenant=${tenantId}`, 'dropbox_oauth', 'width=800,height=600');
        }

        function stopSync() {
            syncShouldStop = true;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('stopButton').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Stopping...';
        }

        async function syncDropbox() {
            const syncButton = document.getElementById('syncButton');
            const stopButton = document.getElementById('stopButton');
            const originalText = syncButton.innerHTML;
            
            syncShouldStop = false;
            syncButton.disabled = true;
            syncButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            stopButton.disabled = false;
            stopButton.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop';
            
            let totalProcessed = 0;
            
            try {
                const model = getCurrentModel();
                let hasMore = true;

                while (hasMore && !syncShouldStop) {
                    syncButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Syncing... (${totalProcessed})`;

                    const response = await fetch(`/api/v1/sync?model=${encodeURIComponent(model)}`, {
                        method: 'POST',
                        headers: {
                            'X-Tenant-ID': currentTenant
                        }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Sync failed');
                    }
                    
                    const result = await response.json();
                    totalProcessed += result.processed;
                    hasMore = result.has_more && result.processed > 0;
                    
                    // Show status message
                    if (result.status_message) {
                        const statusDiv = document.getElementById('syncStatus');
                        const statusText = document.getElementById('syncStatusText');
                        statusText.innerHTML = `<strong>${result.filename || 'Processing'}</strong><br>${result.status_message}`;
                        statusDiv.classList.remove('hidden');
                    }
                    
                    // Reload images after each image is processed
                    if (result.processed > 0) {
                        await loadImages();
                    }
                    
                    // Stop if no more images to process
                    if (!hasMore) {
                        break;
                    }
                }
                
                const status = syncShouldStop ? 'Stopped' : 'Done';
                syncButton.innerHTML = `<i class="fas fa-check mr-2"></i>${status} (${totalProcessed})`;
                
                // Hide status after a moment
                setTimeout(() => {
                    document.getElementById('syncStatus').classList.add('hidden');
                }, 3000);
                
                setTimeout(() => {
                    syncButton.innerHTML = originalText;
                    syncButton.disabled = false;
                    syncButton.classList.remove('hidden');
                    stopButton.classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('Sync error:', error);
                alert('✗ Sync failed: ' + error.message);
                syncButton.disabled = false;
                syncButton.innerHTML = originalText;
                syncButton.classList.remove('hidden');
                stopButton.classList.add('hidden');
            }
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Toggle tag details section
        function toggleTagDetails() {
            const section = document.getElementById('tagDetailsSection');
            const icon = document.getElementById('tagDetailsIcon');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.style.transform = 'rotate(90deg)';
            } else {
                section.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleExifDetails() {
            const section = document.getElementById('exifDetailsSection');
            const icon = document.getElementById('exifDetailsIcon');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.style.transform = 'rotate(90deg)';
            } else {
                section.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleDropboxProperties() {
            const section = document.getElementById('dropboxPropertiesSection');
            const icon = document.getElementById('dropboxPropertiesIcon');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.style.transform = 'rotate(90deg)';
            } else {
                section.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Permatag functions
        async function addPermatag() {
            const keyword = document.getElementById('newPermatagKeyword').value.trim();
            const signum = parseInt(document.getElementById('newPermatagSignum').value);
            
            if (!keyword) {
                alert('Please enter a keyword');
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/images/${window.currentImageId}/permatags`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': currentTenant
                    },
                    body: JSON.stringify({ keyword, signum })
                });
                
                if (!response.ok) throw new Error('Failed to add permatag');
                
                // Clear input
                document.getElementById('newPermatagKeyword').value = '';
                
                // Refresh image details
                await refreshImageDetails();
            } catch (error) {
                console.error('Error adding permatag:', error);
                alert('Failed to add permatag');
            }
        }

        async function deletePermatag(permatagId) {
            if (!confirm('Remove this permatag?')) return;
            
            try {
                const response = await fetch(`/api/v1/images/${window.currentImageId}/permatags/${permatagId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });
                
                if (!response.ok) throw new Error('Failed to delete permatag');
                
                await refreshImageDetails();
            } catch (error) {
                console.error('Error deleting permatag:', error);
                alert('Failed to delete permatag');
            }
        }

        async function acceptAllTags() {
            if (!confirm('Accept all current tags as permatags and reject all others?')) return;
            
            const button = document.getElementById('acceptAllBtn');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Processing...';
            
            try {
                const response = await fetch(`/api/v1/images/${window.currentImageId}/permatags/accept-all`, {
                    method: 'POST',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });
                
                if (!response.ok) throw new Error('Failed to accept tags');
                
                const result = await response.json();
                alert(`✓ Accepted ${result.positive_permatags} tags, rejected ${result.negative_permatags} keywords`);
                
                await refreshImageDetails();
            } catch (error) {
                console.error('Error accepting tags:', error);
                alert('Failed to accept tags');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function showTagActions(event, keyword, category) {
            event.stopPropagation();
            
            const actions = `
                <div class="absolute z-10 bg-white shadow-lg rounded-lg p-2 border border-gray-200" 
                     style="top: ${event.clientY}px; left: ${event.clientX}px;">
                    <button onclick="promoteToPermatag('${keyword}', '${category}', 1)" 
                            class="block w-full text-left px-3 py-2 text-sm hover:bg-green-100 rounded">
                        <i class="fas fa-check text-green-600 mr-2"></i>Approve
                    </button>
                    <button onclick="promoteToPermatag('${keyword}', '${category}', -1)" 
                            class="block w-full text-left px-3 py-2 text-sm hover:bg-red-100 rounded">
                        <i class="fas fa-times text-red-600 mr-2"></i>Reject
                    </button>
                    <button onclick="closeTagActions()" 
                            class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded border-t mt-1">
                        Cancel
                    </button>
                </div>
            `;
            
            // Remove any existing action menu
            closeTagActions();
            
            const menu = document.createElement('div');
            menu.id = 'tagActionsMenu';
            menu.innerHTML = actions;
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeTagActions, { once: true });
            }, 10);
        }

        function closeTagActions() {
            const menu = document.getElementById('tagActionsMenu');
            if (menu) menu.remove();
        }

        async function promoteToPermatag(keyword, category, signum) {
            closeTagActions();
            
            try {
                const response = await fetch(`/api/v1/images/${window.currentImageId}/permatags`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': currentTenant
                    },
                    body: JSON.stringify({ keyword, category, signum })
                });
                
                if (!response.ok) throw new Error('Failed to promote tag');
                
                await refreshImageDetails();
            } catch (error) {
                console.error('Error promoting tag:', error);
                alert('Failed to promote tag to permatag');
            }
        }

        async function refreshImageDetails() {
            if (!window.currentImageId) return;
            
            try {
                const response = await fetch(`/api/v1/images/${window.currentImageId}`, {
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });
                const details = await response.json();
                
                window.currentImageDetails = details;
                
                // Build permatag lookup maps
                const permatagMap = {};
                if (details.permatags) {
                    details.permatags.forEach(p => {
                        permatagMap[p.keyword] = p.signum;
                    });
                }
                
                // 1. Current Tags (machine tags - negative permatags + positive permatags)
                const currentTagsDiv = document.getElementById('currentTags');
                const currentTags = [];
                
                // Add machine tags that aren't negatively permatagged
                if (details.tags) {
                    details.tags.forEach(tag => {
                        if (permatagMap[tag.keyword] !== -1) {
                            currentTags.push({
                                keyword: tag.keyword,
                                category: tag.category,
                                source: 'machine',
                                confidence: tag.confidence
                            });
                        }
                    });
                }
                
                // Add positive permatags
                if (details.permatags) {
                    details.permatags.forEach(p => {
                        if (p.signum === 1) {
                            // Check if it's not already in machine tags
                            const alreadyInMachine = details.tags && details.tags.some(t => t.keyword === p.keyword);
                            if (!alreadyInMachine) {
                                currentTags.push({
                                    keyword: p.keyword,
                                    category: p.category,
                                    source: 'permatag'
                                });
                            }
                        }
                    });
                }
                
                if (currentTags.length > 0) {
                    currentTagsDiv.innerHTML = currentTags.map(tag => {
                        // Green if tag is in permatags (regardless of source), blue if only in machine tags
                        const isInPermatags = permatagMap.hasOwnProperty(tag.keyword);
                        const bgColor = isInPermatags ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                        const confidenceText = tag.confidence ? ` <span class="text-xs text-gray-500">(${Math.round(tag.confidence * 100)}%)</span>` : '';
                        return `<span class="inline-block ${bgColor} px-3 py-1 rounded-full text-sm">
                            ${tag.keyword}${confidenceText}
                        </span>`;
                    }).join(' ');
                } else {
                    currentTagsDiv.innerHTML = '<div class="text-gray-400">No active tags</div>';
                }
                
                // 2. Machine Generated Tags (all image_tags with dates)
                const tagsDiv = document.getElementById('imageTags');
                if (details.tags && details.tags.length > 0) {
                    tagsDiv.innerHTML = details.tags.map(tag => {
                        const dateStr = tag.created_at ? new Date(tag.created_at).toLocaleDateString() : 'Unknown';
                        const isRejected = permatagMap[tag.keyword] === -1;
                        
                        if (isRejected) {
                            // Show with strikethrough, no reject button
                            return `<span class="inline-block bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-sm">
                                <span class="line-through" title="Rejected by permatag">
                                    ${tag.keyword} <span class="text-xs text-gray-400">(${Math.round(tag.confidence * 100)}% • ${dateStr})</span>
                                </span>
                            </span>`;
                        } else {
                            // Normal display with approve/reject buttons
                            return `<span class="inline-block bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors group relative">
                                <span onclick="promoteToPermatag('${tag.keyword}', '${tag.category || ''}', 1)" class="cursor-pointer" title="Click to approve">
                                    ${tag.keyword} <span class="text-xs text-gray-500">(${Math.round(tag.confidence * 100)}% • ${dateStr})</span>
                                </span>
                                <button onclick="promoteToPermatag('${tag.keyword}', '${tag.category || ''}', -1); event.stopPropagation();" 
                                        class="ml-1 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:text-red-600"
                                        title="Reject this tag">
                                    −
                                </button>
                            </span>`;
                        }
                    }).join(' ');
                } else {
                    tagsDiv.innerHTML = '<div class="text-gray-400">No machine tags</div>';
                }
                
                // 3. Permatags (with dates)
                const permatagsDiv = document.getElementById('imagePermatags');
                if (details.permatags && details.permatags.length > 0) {
                    // Sort: positive (signum=1) first, negative (signum=-1) last
                    const sortedPermatags = [...details.permatags].sort((a, b) => b.signum - a.signum);
                    permatagsDiv.innerHTML = sortedPermatags.map(permatag => {
                        const isPositive = permatag.signum === 1;
                        const bgColor = isPositive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const icon = isPositive ? '✓' : '−';
                        const dateStr = permatag.created_at ? new Date(permatag.created_at).toLocaleDateString() : 'Unknown';
                        return `<span class="${bgColor} inline-block px-3 py-1 rounded-full text-sm relative group">
                            ${icon} ${permatag.keyword} <span class="text-xs opacity-75">(${dateStr})</span>
                            <button onclick="deletePermatag(${permatag.id})" 
                                    class="ml-2 text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:text-red-600">
                                ×
                            </button>
                        </span>`;
                    }).join(' ');
                } else {
                    permatagsDiv.innerHTML = '<div class="text-gray-400 text-sm">No permatags yet</div>';
                }
            } catch (error) {
                console.error('Error refreshing details:', error);
            }
        }

        // Load tenants into dropdown
        async function loadTenants() {
            try {
                const response = await fetch('/api/v1/admin/tenants');
                const tenants = await response.json();
                
                const select = document.getElementById('tenantSelect');
                const activetenants = tenants.filter(t => t.active);
                
                if (activetenants.length === 0) {
                    select.innerHTML = '<option value="">No active tenants</option>';
                    return;
                }
                
                select.innerHTML = activetenants.map(t => 
                    `<option value="${t.id}">${t.name}</option>`
                ).join('');
                
                // Restore tenant from localStorage if available and valid
                let storedTenant = localStorage.getItem('currentTenant');
                if (storedTenant && activetenants.some(t => t.id === storedTenant)) {
                    currentTenant = storedTenant;
                } else {
                    currentTenant = activetenants[0].id;
                }
                select.value = currentTenant;
                loadKeywords();
                loadImages();
            } catch (error) {
                console.error('Error loading tenants:', error);
                document.getElementById('tenantSelect').innerHTML = '<option value="">Error loading tenants</option>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Make switchTenant globally available
            window.switchTenant = function(tenantId) {
                currentTenant = tenantId;
                // Persist selection
                localStorage.setItem('currentTenant', tenantId);
                // Reset all keyword/filter state and taxonomy
                selectedKeywords = new Set();
                selectedKeywordsByCategory = {};
                categoryOperators = {};
                availableKeywords = {};
                // Clear filter UI and taxonomy UI
                const container = document.getElementById('categoryInputsContainer');
                if (container) container.innerHTML = '';
                document.getElementById('activeFiltersCount').textContent = '0';
                document.getElementById('activeFiltersCount').classList.add('hidden');
                // Reload data
                loadKeywords();
                loadImages();
            };
            loadEnvironment();
            loadTenants();
        });

        // Load environment badge
        async function loadEnvironment() {
            try {
                const response = await fetch('/api/v1/config/system');
                const systemSettings = await response.json();

                const badge = document.getElementById('environment-badge');
                const env = systemSettings.environment.toUpperCase();
                badge.textContent = env;

                // Color-code environment
                if (systemSettings.environment.toLowerCase() === 'prod') {
                    badge.style.backgroundColor = '#c53030';
                    badge.style.color = 'white';
                } else {
                    badge.style.backgroundColor = '#38a169';
                    badge.style.color = 'white';
                }
            } catch (error) {
                console.error('Error loading environment:', error);
                document.getElementById('environment-badge').textContent = 'ERROR';
                document.getElementById('environment-badge').style.backgroundColor = '#999';
                document.getElementById('environment-badge').style.color = 'white';
            }
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeUploadModal();
            }
        });
    </script>
</body>
</html>
